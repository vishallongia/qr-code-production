<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subscription Plans</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="/css/plans.css" rel="stylesheet">
</head>

<body>

    <div class="container" style="margin-top: 10px;">
        <!-- <h1>Choose Your Subscription</h1> -->
        <% if (needsCurrencySelection) { %>
             <div style="display:flex; justify-content: end;">
        <select id="currencySwitcherApp" class="language-selector-select active"
            style="width: 100%; max-width: 280px; margin: 10px 0px;">
            <option value="EUR" <%= activeCurrency === 'EUR' ? 'selected' : '' %>>EUR</option>
            <option value="CHF" <%= activeCurrency === 'CHF' ? 'selected' : '' %>>CHF</option>
            <option value="HUF" <%= activeCurrency === 'HUF' ? 'selected' : '' %>>HUF</option>
        </select>
    </div>
                <% } %>

            <div class="tabs">
                <% if (user?.subscription?.isVip) { %>
                    <div class="tab active" id="current-subscription-tab"
                        style="display: flex; align-items: center; gap: 5px;"><img class="logo" alt="Logo"
                            src="/Vip.png">VIP
                        Subscription</div>
                    <% } else { %>
                        <div class="tab active" id="plans-tab" data-translate="subscription_plans">Subscription Plans
                        </div>
                        <div class="tab" id="current-subscription-tab" data-translate="current_subscription"
                            style="display: none;">Current
                            Subscription</div>
                        <% } %>
            </div>
            <% if (!user?.subscription?.isVip) { %>
                <div class="tab-content active" id="plans-tab-content">
                    <div class="plans">
                        <% const userCurrency=user?.userPreferences?.currency || activeCurrency || "EUR" ; plans.filter(plan=>
                            plan.recurring).forEach(plan => {
                            const sanitizedId = plan.encryptedId.replace(/[^a-zA-Z0-9-_]/g, "");
                            const eurPriceObj = plan.prices.find(p => p.currency === userCurrency); // default to EUR
                            const displayPrice = eurPriceObj ? eurPriceObj.amount : plan.prices[0].amount;
                            const displayCurrency = eurPriceObj ? eurPriceObj.currency : plan.prices[0].currency;
                            %>
                            <div class="plan-card">
                                <div class="plan-duration">
                                    <%= plan.publicName %>
                                </div>
                                <div class="plan-price" id="plan-price-<%= sanitizedId %>">
                                    <%= displayPrice %>
                                        <%= displayCurrency %>
                                </div>
                                <ul class="features">
                                    <% plan.features.forEach(feature=> { %>
                                        <li>
                                            <%= feature %>
                                        </li>
                                        <% }); %>
                                </ul>

                                <!-- ✅ Coupon Code Input -->
                                <div class="coupon-section" style="margin-bottom: 10px; display: none;">
                                    <input type="text" class="coupon-input" placeholder="Enter coupon code"
                                        id="coupon-code-<%= sanitizedId %>" />
                                </div>
                                <!-- <button id="add-coupon-button-<%= plan.encryptedId %>" class="subscribe-btn add-coupon-btn"
                                data-plan-id="<%= plan.encryptedId %>" style="margin-bottom: 10px; display: none;">
                                Add Coupon
                            </button> -->
                                <% if (needsCurrencySelection) { %>
                                    <button id="lock-curreny-button-<%= plan.encryptedId %>"
                                        class="lock-curreny-button subscribe-btn" data-plan-id="<%= plan.encryptedId %>"
                                        style="margin-bottom: 10px;"
                                        onClick="showCurrencyPopup('<%= plan.encryptedId %>')">
                                        Proceed to pay
                                    </button>
                                    <% } %>
                                        <div id="coupon-success-message-<%= plan.encryptedId %>" style="display: none;"
                                            class="coupon-success-message">
                                            Coupon Added
                                        </div>

                                        <div>
                                            <!-- ✅ Pay with Credit Card Button -->
                                            <!-- <button id="checkout-button-<%= plan.encryptedId %>" class="checkout-btn subscribe-btn"
                                    style="margin-bottom: 10px;">
                                    Pay with Credit Card
                                </button> -->

                                            <!-- ✅ PayPal Button Container -->
                                            <div id="paypal-button-container-<%= sanitizedId %>"
                                                class="paypal-button-container"
                                                style="margin-top: 20px; <%= needsCurrencySelection ? 'display:none;' : 'display:block;' %>"
                                                data-plan-id="<%= plan.encryptedId %>">
                                            </div>
                                        </div>
                            </div>
                            <% }); %>
                    </div>
                    <div style="display: flex; justify-content: center; margin-top: 20px;">
                        <div class="tab" id="current-subscription-tab" data-translate="current_subscription">Current
                            Subscription</div>
                    </div>
                    <div class="tab-content <%= user?.subscription?.isVip ? 'active' : '' %>"
                        id="current-subscription-tab-content">
                        <% if (user?.subscription?.isVip) { %>
                            <div class="subscription-card">
                                <div class="status-badge active">VIP Subscription</div>
                                <div class="subscription-details">
                                    <p><i class="fas fa-user"></i> <strong>Name :&nbsp;</strong>
                                        <%= user.name %>
                                    </p>
                                    <p><i class="fas fa-envelope"></i> <strong>Email :&nbsp;</strong>
                                        <%= user.email %>
                                    </p>
                                    <p><i class="fas fa-calendar-alt"></i> <strong>Valid Until&nbsp;:&nbsp;</strong>
                                        <% if (user.subscription.validTill) { const vipDate=new
                                            Date(user.subscription.validTill); const
                                            dd=String(vipDate.getDate()).padStart(2, '0' ); const
                                            mm=String(vipDate.getMonth() + 1).padStart(2, '0' ); const
                                            yy=vipDate.getFullYear(); %>
                                            <%= `${dd}-${mm}-${yy}` %>
                                                <% } else { %>
                                                    N/A
                                                    <% } %>
                                    </p>
                                </div>
                            </div>
                            <% } else { %>
                                <div class="subscription-card">
                                    <% if (!user.validUntil || new Date(user.validUntil) < new Date()) { %>
                                        <div class="status-badge expired">No Active Subscription</div>
                                        <p class="no-subscription-message">Subscribe now to enjoy premium features.</p>
                                        <% } else { %>
                                            <div class="status-badge active" data-translate="active_subscription">Active
                                                Subscription</div>
                                            <div class="subscription-details">
                                                <p><i class="fas fa-user"></i> <strong> <span
                                                            data-translate="full_name">Name</span> :&nbsp;</strong>
                                                    <%= user.name %>
                                                </p>
                                                <p><i class="fas fa-envelope"></i> <strong> <span
                                                            data-translate="email_address">Email</span> :&nbsp;</strong>
                                                    <%= user.email %>
                                                </p>
                                                <p><i class="fas fa-calendar-alt"></i> <strong><span
                                                            data-translate="valid_until">Valid
                                                            Until</span>&nbsp;:&nbsp;</strong>
                                                    <% if (user.validUntil) { const date=new Date(user.validUntil);
                                                        const dd=String(date.getDate()).padStart(2, '0' ); const
                                                        mm=String(date.getMonth() + 1).padStart(2, '0' ); const
                                                        yy=date.getFullYear(); %>
                                                        <%= `${dd}-${mm}-${yy}` %>
                                                            <% } else { %>
                                                                N/A
                                                                <% } %>
                                                </p>
                                                <p><i class="fas fa-clock"></i> <strong>Time
                                                        Remaining&nbsp;:&nbsp;</strong>
                                                    <span id="time-remaining"
                                                        data-translate="time_remaining">Loading...</span>
                                                </p>
                                            </div>
                                            <% } %>
                                </div>
                                <% } %>
                    </div>

                </div>
                <% } %>

                    <!-- <div class="tab-content <%= user?.subscription?.isVip ? 'active' : '' %>"
                    id="current-subscription-tab-content">
                    <% if (user?.subscription?.isVip) { %>
                        <div class="subscription-card">
                            <div class="status-badge active">VIP Subscription</div>
                            <div class="subscription-details">
                                <p><i class="fas fa-user"></i> <strong>Name :&nbsp;</strong>
                                    <%= user.name %>
                                </p>
                                <p><i class="fas fa-envelope"></i> <strong>Email :&nbsp;</strong>
                                    <%= user.email %>
                                </p>
                                <p><i class="fas fa-calendar-alt"></i> <strong>Valid Until&nbsp;:&nbsp;</strong>
                                    <% if (user.subscription.validTill) { const vipDate=new
                                        Date(user.subscription.validTill); const
                                        dd=String(vipDate.getDate()).padStart(2, '0' ); const
                                        mm=String(vipDate.getMonth() + 1).padStart(2, '0' ); const
                                        yy=vipDate.getFullYear(); %>
                                        <%= `${dd}-${mm}-${yy}` %>
                                            <% } else { %>
                                                N/A
                                                <% } %>
                                </p>
                            </div>
                        </div>
                        <% } else { %>
                            <div class="subscription-card">
                                <% if (!user.validUntil || new Date(user.validUntil) < new Date()) { %>
                                    <div class="status-badge expired">No Active Subscription</div>
                                    <p class="no-subscription-message">Subscribe now to enjoy premium features.</p>
                                    <% } else { %>
                                        <div class="status-badge active" data-translate="active_subscription">Active
                                            Subscription</div>
                                        <div class="subscription-details">
                                            <p><i class="fas fa-user"></i> <strong> <span
                                                        data-translate="full_name">Name</span> :&nbsp;</strong>
                                                <%= user.name %>
                                            </p>
                                            <p><i class="fas fa-envelope"></i> <strong> <span
                                                        data-translate="email_address">Email</span> :&nbsp;</strong>
                                                <%= user.email %>
                                            </p>
                                            <p><i class="fas fa-calendar-alt"></i> <strong><span
                                                        data-translate="valid_until">Valid
                                                        Until</span>&nbsp;:&nbsp;</strong>
                                                <% if (user.validUntil) { const date=new Date(user.validUntil); const
                                                    dd=String(date.getDate()).padStart(2, '0' ); const
                                                    mm=String(date.getMonth() + 1).padStart(2, '0' ); const
                                                    yy=date.getFullYear(); %>
                                                    <%= `${dd}-${mm}-${yy}` %>
                                                        <% } else { %>
                                                            N/A
                                                            <% } %>
                                            </p>
                                            <p><i class="fas fa-clock"></i> <strong>Time Remaining&nbsp;:&nbsp;</strong>
                                                <span id="time-remaining"
                                                    data-translate="time_remaining">Loading...</span>
                                            </p>
                                        </div>
                                        <% } %>
                            </div>
                            <% } %>
                </div> -->
    </div>



</body>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
<script src="/js/toastify-setup.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<script
    src="https://www.paypal.com/sdk/js?client-id=AeUlyT2WmljAHqGaXytGewyz61xmfAJ4woW1wA_2TwjcaqbbjJTkPHy47FsEJhcH68BGlm9-AdDfmbrU&vault=true&intent=subscription""></script>
<script src=" /js/plan.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const containers = document.querySelectorAll(".paypal-button-container");

        // Initialize global meta token storage
        window.paypalMetaTokens = window.paypalMetaTokens || {};

        containers.forEach(container => {
            const planId = container.dataset.planId;
            const sanitizedId = container.id.replace("paypal-button-container-", "");
            const couponInput = document.querySelector(`#coupon-code-${sanitizedId}`);

            paypal.Buttons({
                createSubscription: function () {  // ⚡ For recurring subscriptions
                    const couponCode = couponInput ? couponInput.value.trim() : "";
                        // Grab selected currency from the dropdown
                    const currencySelect = document.getElementById("currencySwitcherApp");
                    const selectedCurrency = currencySelect ? currencySelect.value : '<%= activeCurrency %>'; // fallback to server value
                    return fetch("/paypal/create-subscription", {  // endpoint for recurring
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ planId, couponCode, currency: selectedCurrency })
                    })
                        .then(async res => {
                            if (!res.ok) {
                                const errorData = await res.json();
                                throw new Error(errorData.message || "Failed to create subscription");
                            }
                            return res.json();
                        })
                        .then(data => {
                            if (data.message) {
                                showToast(data.message, "success");
                                if (couponInput) couponInput.value = ""; // Clear input
                            }
                            if (data.id && data.metaToken) {
                                window.paypalMetaTokens[data.id] = data.metaToken;
                            }
                            return data.id;
                        })
                        .catch(err => {
                            console.error("Create Subscription Error:", err);
                            showToast(err.message || "An error occurred while creating subscription", "error");
                            if (couponInput) couponInput.value = "";
                            throw err;
                        });
                },
                onApprove: function (data) {
                    const metaToken = window.paypalMetaTokens[data.subscriptionID];
                    return fetch("/paypal/capture-subscription", { // endpoint for capturing recurring
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ subscriptionID: data.subscriptionID, planId, metaToken })
                    })
                        .then(res => res.json())
                        .then(response => {
                            delete window.paypalMetaTokens[data.subscriptionID];
                            if (response.status === 'ACTIVE' || response.status === 'APPROVED') {
                                if (response.subscriptionId) {
                                    if (couponInput) couponInput.value = "";
                                    window.location.href = `/successpayment?session_id=${response.subscriptionId}`;
                                } else {
                                    alert("Transaction ID not found.");
                                }
                            } else {
                                showToast(response.message, "error");
                                setTimeout(() => window.location.href = `/cancel`, 1000);
                            }
                        });
                },
                onError: function (err) {
                    console.error("PayPal Subscription Error:", err.message);
                    showToast("An error occurred during the transaction.", "error");
                }
            }).render(container);
        });
    });
</script>


<script>// Update remaining time
    function formatTime(milliseconds) {
        let seconds = Math.floor(milliseconds / 1000);
        let minutes = Math.floor(seconds / 60);
        let hours = Math.floor(minutes / 60);
        let days = Math.floor(hours / 24);

        seconds %= 60;
        minutes %= 60;
        hours %= 24;

        let timeString = "";
        if (days > 0) timeString += `${days} days `;
        if (hours > 0) timeString += `${hours} hours `;
        if (minutes > 0) timeString += `${minutes} minutes `;
        if (seconds > 0) timeString += `${seconds} seconds`;
        return timeString;
    }

    function updateTimeRemaining() {
        const validUntil = new Date("<%= user.validUntil %>");
        const now = new Date();
        const timeRemaining = validUntil - now;

        if (timeRemaining <= 0) {
            document.getElementById("time-remaining").textContent =
                "Subscription expired";
        } else {
            document.getElementById("time-remaining").textContent =
                formatTime(timeRemaining);
        }
    }

    setInterval(updateTimeRemaining, 1000);




    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
            if (tab.id === "current-subscription-tab") {
                // Remove active only from other child tabs (not parent)
                tabs.forEach((t) => {
                    if (t.id !== "plans-tab") t.classList.remove("active");
                });

                // Remove active only from other child contents (not parent)
                contents.forEach((c) => {
                    if (c.id !== "plans-tab-content") c.classList.remove("active");
                });

                // Add active to current subscription tab + content
                tab.classList.add("active");
                const target = document.getElementById(tab.id + "-content");
                if (target) {
                    target.classList.add("active");

                    // ✅ Smooth scroll to the shown portion
                    target.scrollIntoView({
                        behavior: "smooth",
                        block: "start"   // or "nearest" if you want less scrolling
                    });
                }
            }
        });
    });




    // Tab toggle
    // const tabs = document.querySelectorAll(".tab");
    // const contents = document.querySelectorAll(".tab-content");

    // tabs.forEach((tab) => {
    //     tab.addEventListener("click", () => {
    //         tabs.forEach((t) => t.classList.remove("active"));
    //         contents.forEach((c) => c.classList.remove("active"));
    //         tab.classList.add("active");

    //         const target = document.getElementById(tab.id + "-content");
    //         if (target) target.classList.add("active");
    //     });
    // });
</script>

<!-- <script>
    document.addEventListener("DOMContentLoaded", function () {
        const popup = document.getElementById("theme-popup-select-currency");


        // Use EJS to pass the flag from backend
        const needsCurrencySelection = <%= needsCurrencySelection ? 'true' : 'false' %>;

        if (needsCurrencySelection) {
            popup.style.display = "flex";
        }

        const popupBtn = document.getElementById("popup-ok-btn-select-currency");
        popupBtn.addEventListener("click", async function (e) {
            e.preventDefault();

            const currencySelect = document.getElementById("currency-value");
            const selectedCurrency = currencySelect.value;

            // ✅ Frontend mandatory check
            if (!selectedCurrency) {
                return showToast("Please select a currency!", "error");
            }

            // Show loader
            document.getElementById("loader").style.display = "flex";

            try {
                const res = await fetch("/set-currency", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ currency: selectedCurrency })
                });

                const data = await res.json();

                if (!res.ok) {
                    return showToast(data.message || "Failed to set currency", "error");
                }

                // ✅ Success
                showToast(data.message || "Currency set successfully", "success");

                // Hide popup
                popup.style.display = "none";

                // 🔄 Reload page after 1 second
                setTimeout(() => location.reload(), 1000);

            } catch (err) {
                console.error("Error setting currency:", err);
                showToast("Internal error. Please try again.", "error");
            } finally {
                // Hide loader regardless of success or failure
                document.getElementById("loader").style.display = "none";
            }
        });
    });
</script> -->


<script>
    document.getElementById("currencySwitcherApp").addEventListener("change", function () {
        const url = new URL(window.location);
        url.searchParams.set("currency", this.value);
        window.location = url;
    });
    function showCurrencyPopup(planId) {
        const popup = document.getElementById("theme-popup-select-currency");
        const okBtn = document.getElementById("popup-ok-btn-select-currency");
        const cancelBtn = document.getElementById("popup-cancel-btn-select-currency");
        const currencySwitcher = document.getElementById("currencySwitcherApp");

        popup.style.display = "flex";

        const cleanup = () => {
            popup.style.display = "none";
            okBtn.onclick = null;
            cancelBtn.onclick = null;
        };

        okBtn.onclick = (e) => {
            e.preventDefault();
            cleanup();
            // ✅ Continue your logic here, e.g., show PayPal button for this plan
            // Select all PayPal button containers
            const allPaypalContainers = document.querySelectorAll(".paypal-button-container");

            // Show all containers
            allPaypalContainers.forEach(container => {
                container.style.display = "block";
            });

            const allLockCurrencyButton = document.querySelectorAll(".lock-curreny-button");
            allLockCurrencyButton.forEach(container => {
                container.style.display = "none";
            });
            currencySwitcher.style.display="none";

            // Render PayPal buttons here if needed
            // renderPayPalButtons(planId);
        };

        cancelBtn.onclick = (e) => {
            e.preventDefault();
            cleanup();
            // ❌ Cancelled, do nothing
        };
    }
</script>


</html>