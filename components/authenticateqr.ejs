<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Magic Code Cards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/css/qr-gallery-new.css" rel="stylesheet">
</head>

<body>
    <div class="container-qr-custom">
        <span style="font-family: Poppins;
        font-weight: 600;
        font-size: 20px;
        line-height: 20px;">My Magic Codes</span>

        <div class="grid">
            <% if (qrCodes.length> 0) { %>
                <% qrCodes.forEach(function(qrCode) { %>
                    <div class="card" id="showqrcards" data-id="<%= qrCode._id %>">
                        <p class="card-title">
                            <%= qrCode.qrName %>
                        </p>
                        <div class="qr-code" id="qr-container-<%= qrCode._id %>"></div>


                    </div>
                    <% }) %>
                        <% } else { %>
                            <p id="NoQR">No Magic codes found.</p>
                            <% } %>
        </div>

    </div>
    <div style="display: flex; justify-content: center; gap: 12px;">
        <button class="btn" style="margin: 0px;" id="btn-authenticate"
            onclick="authenticateQRCodes()">Authenticate</button>
        <!-- Link with Magic Code button (hidden by default) -->
        <button id="btn-create-magic-code" style="margin: 0px;" class="btn" style="display:none;">Create New Magic
            Code</button>
        <button id="btn-link-magic" style="margin:0px;" class="btn" style="display:none;" onclick="linkMagicCode()">Link
            with Magic
            Code</button>
    </div>



    <script>
        const qrCodesMap = {};

        function showQrCodes(qrCodes) {
            qrCodes.forEach((qrCodeData) => {
                const qrContainer = document.getElementById(`qr-container-${qrCodeData._id}`);
                let logoUrl = qrCodeData.logo ? `${window.location.protocol}//${window.location.host}/${qrCodeData.logo}` : "";


                if (qrContainer) {
                    const qrCode = new QRCodeStyling({
                        width: 3000,
                        height: 3000,
                        type: "canvas",
                        data: `${window.location.protocol}//${window.location.host}/${qrCodeData.code}`,
                        dotsOptions: {
                            color: qrCodeData.qrDotColor || "#000000",
                            type: qrCodeData.dotStyle || "square",
                            gradient: qrCodeData.applyGradient === "linear" ? {
                                type: "linear",
                                colorStops: [
                                    { offset: 0, color: "#ff0000" },
                                    { offset: 1, color: qrCodeData.qrDotColor || "#000000" }
                                ]
                            } : qrCodeData.applyGradient === "radial" ? {
                                type: "radial",
                                colorStops: [
                                    { offset: 0, color: "#ff0000" },
                                    { offset: 1, color: qrCodeData.qrDotColor || "#000000" }
                                ]
                            } : null
                        },
                        backgroundOptions: {
                            color: qrCodeData.backgroundColor || "#ffffff"
                        },
                        cornersSquareOptions: {
                            type: qrCodeData.cornerStyle || "square"
                        },
                        image: logoUrl,
                        imageOptions: {
                            crossOrigin: "anonymous",
                            margin: 10
                        }
                    });



                    // Clear existing content to avoid duplicates
                    qrContainer.innerHTML = "";

                    // Create wrapper to hold QR and optional badge
                    const wrapper = document.createElement("div");
                    wrapper.style.position = "relative";
                    wrapper.style.display = "inline-block";

                    // Create a div to hold the QR code canvas
                    const qrCanvasDiv = document.createElement("div");
                    wrapper.appendChild(qrCanvasDiv);
                    if (qrCodeData.isFirstQr) {
                        const cardElement = qrContainer.closest(".card");
                        if (cardElement && !cardElement.querySelector(".ribbon-triangle")) {
                            const ribbon = document.createElement("div");
                            ribbon.className = "ribbon-triangle";

                            const text = document.createElement("span");
                            text.textContent = "FREE";

                            ribbon.appendChild(text);
                            cardElement.appendChild(ribbon);
                        }
                    }

                    qrCode.append(qrCanvasDiv);
                    qrContainer.appendChild(wrapper);
                    qrCodesMap[qrCodeData._id] = qrCode;

                }
            });
        }

        function downloadQRCodeShowed(qrCodeId) {
            const qrCode = qrCodesMap[qrCodeId];
            if (qrCode) {
                qrCode.download({ name: "qr-code", extension: "png", width: 1600, height: 1600 });
            }
        }

        // Initialize QR codes
        const qrCodesFromServer = <%- JSON.stringify(qrCodes) %>;
        showQrCodes(qrCodesFromServer);
    </script>

    <script>
        const selectedQrIds = new Set();
        // Get sessionId from URL query param
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("sessionId");
        channelId = urlParams.get("channelId");
        const type = urlParams.get("type");
        const singleSelection = !!sessionId; // only one QR can be selected if sessionId exists

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".card[data-id]").forEach(card => {
                card.addEventListener("click", () => {
                    const id = card.getAttribute("data-id");

                    if (singleSelection) {
                        // Unselect all other cards
                        document.querySelectorAll(".card.tile-selected").forEach(c => c.classList.remove("tile-selected"));
                        selectedQrIds.clear();
                        card.classList.add("tile-selected");
                        selectedQrIds.add(id);
                    } else {
                        // Multiple selection
                        if (card.classList.contains("tile-selected")) {
                            card.classList.remove("tile-selected");
                            selectedQrIds.delete(id);
                        } else {
                            card.classList.add("tile-selected");
                            selectedQrIds.add(id);
                        }
                    }
                });

                //
            });

            // Show/hide buttons based on sessionId
            if (sessionId) {
                document.getElementById("btn-authenticate").style.display = "none";
                document.getElementById("btn-link-magic").style.display = "block";
                const linkBtn = document.getElementById("btn-link-magic");
                const createMagicButton = document.getElementById("btn-create-magic-code");
                linkBtn.style.display = "flex";
                createMagicButton.style.display = "flex"

                createMagicButton.onclick = () => {
                    window.location.href = `/dashboard?sessionId=${sessionId}&channelId=${channelId}&type=${type}&linked=true`;
                };

                if (document.getElementById("NoQR")) {
                    linkBtn.textContent = "Link to New Magic Code";
                    linkBtn.onclick = () => {
                        window.location.href = `/dashboard?sessionId=${sessionId}&channelId=${channelId}&type=${type}&linked=true`;
                    };
                } else {
                    linkBtn.onclick = linkMagicCode;
                }

            } else {
                document.getElementById("btn-authenticate").style.display = "flex";
                document.getElementById("btn-link-magic").style.display = "none";
            }

        });
    </script>

    <script>
        async function authenticateQRCodes() {
            const pathParts = window.location.pathname.split("/");
            const couponId = pathParts[pathParts.length - 1]; // last part of URL

            const selectedQRs = Array.from(document.querySelectorAll(".tile-selected"))
                .map(card => card.getAttribute("data-id"));

            if (!couponId || selectedQRs.length === 0) {
                showToast("Please select at least one QR and ensure coupon ID is available.", "error");
                return;
            }

            document.getElementById("loader").style.display = "flex"

            try {
                const res = await fetch("/set-special-offer-qrs", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        couponId,
                        qrCodeIds: selectedQRs,
                    }),
                });

                const data = await res.json();
                if (res.ok) {
                    showToast(data.message, "success");
                    setTimeout(() => {
                        window.location.href = "/usercontrol";
                    }, 1000);
                } else {
                    showToast(data.message || "Failed to authenticate QR codes.", "error");
                }
            } catch (err) {
                console.error("Request error:", err);
                showToast("Something went wrong.", "error");
            }
            finally {
                document.getElementById("loader").style.display = "none"
            }
        }

        // Function to call your link-magic-code API
        async function linkMagicCode() {
            const selectedQRs = Array.from(document.querySelectorAll(".tile-selected"))
                .map(card => card.getAttribute("data-id"));

            if (selectedQRs.length === 0) {
                showToast("Please select at least one QR code.", "error");
                return;
            }

            document.getElementById("loader").style.display = "flex"

            try {
                const res = await fetch(`/tvstation/link-magic-code?sessionId=${sessionId}&type=${type}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ qrCodeId: selectedQRs[0] }) // if multiple, you can handle multiple IDs
                });

                const data = await res.json();
                if (res.ok) {
                    showToast(data.message, "success");
                    // Redirect to the quiz link sent by backend
                    if (data.link) {
                        setTimeout(() => {
                            window.location.href = data.link;
                        }, 1000); // small delay to show success toast
                    }
                } else {
                    showToast(data.message || "Failed to link Magic Code.", "error");
                }
            } catch (err) {
                console.error(err);
                showToast("Something went wrong.", "error");
            }
            finally {
                document.getElementById("loader").style.display = "none"
            }
        }

    </script>

</body>


</html>