<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Management</title>
    <link rel="stylesheet" href="/css/channel-quiz.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
</head>

<body>


    <div class="quiz-admin-container">
        <% if (error) { %>
            <div class="quiz-admin-error">
                <%= error %>
            </div>
            <% } else { %>
                <div class="quiz-admin-header">
                    <h1>Quiz Manager</h1>
                    <div class="quiz-admin-controls">
                        <% if (!quizQuestions || quizQuestions.length===0) { %>
                            <button
                                onclick="window.open('/tvstation/channels/<%= channel._id %>/session/<%= sessionId %>/addquestion', '_blank')"
                                class="btn">
                                + Add New Question
                            </button>
                            <% } %>
                                <!-- <button id="startChannelBtn" class="start-btn btn">
                            <%= channel.isRunning && channel.typeOfRunning==="quiz" ? "Stop" : "Start" %>
                        </button> -->
                                <!-- <button class="winner-btn btn">Draw Winner</button> -->
                                <button class="logs-btn btn"
                                    onclick="location.href='/tvstation/channel/<%= channel._id %>/session/<%= sessionId %>/quiz-response-tracker'">Track
                                    Logs</button>
                    </div>
                </div>

                <div class="quiz-admin-questions">
                    <% if (quizQuestions && quizQuestions.length> 0) { %>
                        <% quizQuestions.forEach((q, index)=> { %>
                            <div class="quiz-admin-question-card">
                                <div class="quiz-admin-question-text">
                                    <%= q.question %>
                                </div>
                                <div class="quiz-admin-info">
                                    <span>
                                        <strong>Correct Answer:</strong>
                                        <%= String.fromCharCode(65 + q.correctAnswerIndex) %>
                                    </span>
                                    <span><strong>Magic Coins Deducted:</strong>
                                        <%= q.magicCoinDeducted || 0 %>
                                    </span>
                                </div>
                                <div class="quiz-admin-actions">
                                    <a href="/tvstation/channels/<%= channel._id %>/session/<%= sessionId %>/editquestion/<%= q._id %>"
                                        target="_blank">
                                        <button>Edit</button>
                                    </a>
                                    <button class="delete-btn delete" data-question-id="<%= q._id %>">Delete</button>

                                </div>
                            </div>
                            <% }) %>
                                <% } else { %>
                                    <p style="padding: 1rem;">No quiz questions available.</p>
                                    <% } %>
                </div>
                <% if (hasMore) { %>
                    <div class="quiz-admin-load" id="loadMoreContainer">
                        <button id="loadMoreBtn">Load More</button>
                        <div id="loadingText"
                            style="display: none; text-align: center; margin-top: 10px; font-weight: 500;">
                            Loading...
                        </div>
                    </div>
                    <% } %>

                        <script>

                            let skipCount = <%= quizQuestions.length %>;
                            const channelId = "<%= channel._id %>";

                            const loadMoreBtn = document.getElementById("loadMoreBtn");
                            const loadingText = document.getElementById("loadingText");

                            if (loadMoreBtn) {
                                loadMoreBtn.addEventListener("click", async () => {
                                    try {
                                        loadMoreBtn.style.display = "none";
                                        loadingText.style.display = "block";

                                        const res = await fetch(`/tvstation/channels/${channelId}/quiz?skip=${skipCount}&limit=5`, {
                                            headers: {
                                                Accept: "application/json"
                                            }
                                        });

                                        const json = await res.json();

                                        if (json.type === "success" && Array.isArray(json.data)) {
                                            const container = document.querySelector(".quiz-admin-questions");

                                            json.data.forEach((q) => {
                                                const div = document.createElement("div");
                                                div.className = "quiz-admin-question-card";
                                                div.innerHTML = `
                            <div class="quiz-admin-question-text">${q.question}</div>
                            <div class="quiz-admin-info">
                                <span><strong>Correct Answer:</strong> ${String.fromCharCode(65 + q.correctAnswerIndex)}</span>
                                <span><strong>Magic Coins:</strong> ${q.rewardCoins || 0}</span>
                            </div>
                            <div class="quiz-admin-actions">
                               <a href="/tvstation/channels/${channelId}/editquestion/${q._id}" target="_blank">
                                    <button>Edit</button>
                                </a>
                               <button class="delete-btn delete" data-question-id="${q._id}">Delete</button>
                            </div>
                        `;
                                                container.appendChild(div);
                                            });

                                            skipCount += json.data.length;

                                            if (!json.hasMore || json.data.length < 5) {
                                                document.getElementById("loadMoreContainer").style.display = "none";
                                            } else {
                                                loadMoreBtn.style.display = "inline-block";
                                            }
                                        }
                                    } catch (err) {
                                        console.error("Load more failed", err);
                                        alert("Failed to load more questions.");
                                        loadMoreBtn.style.display = "inline-block";
                                    } finally {
                                        loadingText.style.display = "none";
                                    }
                                });
                            }


                            document.addEventListener("click", async (e) => {
                                if (e.target.classList.contains("delete-btn")) {
                                    const button = e.target;
                                    const questionId = button.getAttribute("data-question-id");

                                    if (!confirm("Are you sure you want to delete this question?")) return;
                                    const loader = document.getElementById("loader");
                                    loader.style.display = "flex"; // show loader
                                    try {
                                        const res = await fetch(`/tvstation/quiz-question/${questionId}`, {
                                            method: "DELETE",
                                            headers: {
                                                "Content-Type": "application/json"
                                            },
                                            body: JSON.stringify({
                                                channelId: "<%= channel._id %>"
                                            })
                                        });

                                        const result = await res.json();

                                        if (result.type === "success") {
                                            showToast(result.message || "Question deleted successfully", "success");
                                            setTimeout(() => {
                                                location.reload();
                                            }, 1000); // Reload after 1 second

                                        } else {
                                            showToast(result.message || "Failed to delete the question", "error");
                                        }
                                    } catch (err) {
                                        console.error("Delete failed", err);
                                        showToast("Server error while deleting the question", "error");
                                    }

                                    finally {
                                        loader.style.display = "none";
                                    }
                                }
                            });
                        </script>
                        <% } %>
                            <h1>Magic Code</h1>
                            <div class="quiz-admin-question-card app-qr-box quiz-admin-questions">
                                <div id="qr-download-container"></div>
                                <!-- Magic Code Download Box -->
                                <div class="type-box">
                                    <!-- Hidden fields for JS -->
                                    <input type="hidden" id="selectedFgHex" value="#000000" />
                                    <input type="hidden" id="selectedBgHex" value="#FFFFFF" />

                                    <!-- Foreground & Background Color Pickers -->
                                    <div class="form-group" id="foreground-color-setting-update"
                                        style="margin-top: 1rem;">
                                        <label for="foreground-color-grid-update">Foreground Color</label>
                                        <div class="color-grid" id="foreground-color-grid-update">
                                            <% const fgColors=[ '#000000' , '#FFFFFF' , '#FF0093' , '#835EC7'
                                                , '#00B760' , '#FC70BA' , '#1C00FF' , '#FF0000' , '#FFC62C' , '#00AEEF'
                                                , '#FEFE00' , '#4CCED1' ]; %>
                                                <% fgColors.forEach(hex=> { %>
                                                    <div class="color-option"
                                                        style="background-color: <%= hex %>; <%= hex === '#ffffff' ? 'border: 1px solid #ccc;' : '' %>">
                                                    </div>
                                                    <% }) %>
                                        </div>
                                    </div>

                                    <div class="form-group" id="background-color-setting-update">
                                        <label for="background-color-grid-update">Background Color</label>
                                        <div class="color-grid" id="background-color-grid-update">
                                            <% fgColors.forEach(hex=> { %>
                                                <div class="color-option"
                                                    style="background-color: <%= hex %>; <%= hex === '#ffffff' ? 'border: 1px solid #ccc;' : '' %>">
                                                </div>

                                                <% }) %>
                                                    <!-- Transparent Option -->
                                                    <div class="color-option transparent-option"
                                                        data-color="transparent"
                                                        style="background: repeating-conic-gradient(#ccc 0% 25%, transparent 0% 50%) 50% / 10px 10px;">
                                                    </div>
                                        </div>
                                    </div>
                                    <!-- Download Button -->
                                    <!-- <button class="type-btn" onclick="handleMagicCodeUpdate('<%= channel._id %>')">Update</button> -->

                                    <button class="type-btn btn"
                                        onclick="downloadMagicCode('<%= channel._id %>', '<%= sessionId %>', true)"
                                        style="margin-top: 10px;">Update</button>

                                    <button class="type-btn btn"
                                        onclick="downloadMagicCode('<%= channel._id %>', '<%= sessionId %>')"
                                        style="margin-top: 10px;">Download</button>

                                </div>
                            </div>

    </div>

    <script>
        document.getElementById("startChannelBtn")?.addEventListener("click", async () => {
            const pathParts = window.location.pathname.split("/");
            const channelId = pathParts[pathParts.indexOf("channels") + 1]; // Gets channel ID from URL

            if (!channelId) {
                showToast("Channel ID not found", "error");
                return;
            }

            const loader = document.getElementById("loader");
            loader.style.display = "flex"; // show loader

            try {
                const res = await fetch(`/tvstation/channels/${channelId}/toggle`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        isRunning: true,
                        typeOfRunning: "quiz"
                    })
                });

                const result = await res.json();

                if (result.type === "success") {
                    showToast(result.message || "Channel started", "success");
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.message || "Failed to start channel", "error");
                }
            } catch (err) {
                console.error("Start error", err);
                showToast("Server error while starting channel", "error");
            }
            finally {
                loader.style.display = "none"; // hide loader after fetch is done
            }
        });
    </script>



    <script>
        const colorHexMapQuiz = {
            "#000000": "black",
            "#FFFFFF": "white",
            "#FF0093": "magenta",
            "#835EC7": "violet",
            "#00B760": "green",
            "#FC70BA": "pink",
            "#1C00FF": "blue",
            "#FF0000": "red",
            "#FFC62C": "orange",
            "#00AEEF": "cyan",
            "#FEFE00": "yellow",
            "#4CCED1": "turquoise"
        };

        const colorOptionsMap = {
            black: ["white", "pink", "orange", "yellow", "turquoise"],
            white: ["black", "green", "pink", "blue", "orange", "cyan", "yellow", "turquoise"],
            magenta: ["white", "cyan", "yellow", "turquoise"],
            violet: ["white", "cyan", "yellow", "turquoise"],
            green: ["white", "cyan", "yellow", "turquoise"],
            pink: ["white", "blue", "orange", "cyan", "yellow", "turquoise"],
            blue: ["white", "orange", "cyan", "yellow", "turquoise"],
            red: ["pink", "orange", "cyan", "yellow", "turquoise", "white"],
            orange: ["white", "pink", "cyan", "turquoise"],
            cyan: ["white", "black", "violet", "green", "pink", "blue", "orange", "yellow", "turquoise"],
            yellow: ["white", "black", "violet", "green", "pink", "blue", "orange", "cyan", "turquoise"],
            turquoise: ["white", "black", "violet", "green", "pink", "blue", "orange", "cyan", "yellow"]
        };

        const fgGrid = document.getElementById("foreground-color-grid-update");
        const bgGrid = document.getElementById("background-color-grid-update");
        const fgHexInput = document.getElementById("selectedFgHex");
        const bgHexInput = document.getElementById("selectedBgHex");

        function hexToName(hex) {
            return colorHexMapQuiz[hex.toUpperCase()] || null;
        }

        function clearActive(container) {
            container.querySelectorAll(".color-option").forEach(div => div.classList.remove("active"));
        }

        function rgbToHex(rgb) {
            const rgbArr = rgb.match(/\d+/g);
            if (!rgbArr || rgbArr.length < 3) return rgb;
            return "#" + rgbArr.map(val => parseInt(val).toString(16).padStart(2, '0')).join('').toUpperCase();
        }

        fgGrid.querySelectorAll(".color-option").forEach(fgDiv => {
            fgDiv.addEventListener("click", () => {
                clearActive(fgGrid);
                fgDiv.classList.add("active");

                const fgHex = rgbToHex(fgDiv.style.backgroundColor);
                const fgName = hexToName(fgHex);
                fgHexInput.value = fgHex;


                // Preserve transparent selection if already selected
                const transparentSelected = bgHexInput.value === "transparent";

                // Reset background selection
                clearActive(bgGrid);
                bgHexInput.value = "";

                // Show only allowed background options
                const allowed = colorOptionsMap[fgName] || [];
                bgGrid.querySelectorAll(".color-option").forEach(bgDiv => {
                    const bgHex = rgbToHex(bgDiv.style.backgroundColor);
                    const bgName = hexToName(bgHex);

                    // Transparent always visible except when FG = white
                    if (bgDiv.dataset.color === "transparent") {
                        bgDiv.style.display = fgName === "white" ? "none" : "inline-block";
                        bgHexInput.value = "#00000";
                    } else {
                        bgDiv.style.display = (allowed.includes(bgName) && bgName !== fgName) ? "inline-block" : "none";
                    }


                });
            });
        });

        bgGrid.querySelectorAll(".color-option").forEach(bgDiv => {
            bgDiv.addEventListener("click", () => {
                if (bgDiv.style.display === "none") return;
                clearActive(bgGrid);
                bgDiv.classList.add("active");

                const bgDataColor = bgDiv.dataset.color;
                if (bgDataColor === "transparent") {
                    bgHexInput.value = "transparent";
                } else {
                    bgHexInput.value = rgbToHex(bgDiv.style.backgroundColor);
                }



                // Hide white in FG only if BG is transparent
                fgGrid.querySelectorAll(".color-option").forEach(fgDiv => {
                    if (bgData === "transparent" && fgDiv.dataset.color === "white") {
                        fgDiv.style.display = "none";
                        if (fgDiv.classList.contains("active")) {
                            clearActive(fgGrid);
                            fgHexInput.value = "";
                        }
                    } else {
                        fgDiv.style.display = "inline-block";
                    }
                });

                // const bgHex = rgbToHex(bgDiv.style.backgroundColor);
                // bgHexInput.value = bgHex;
            });
        });
    </script>


    <script>
        async function handleMagicCodeUpdate(channelId) {
            const fgHex = document.getElementById("selectedFgHex").value;
            const bgHex = document.getElementById("selectedBgHex").value;

            const body = {};

            if (fgHex) body.qrDotColor = fgHex;
            if (bgHex) body.backgroundColor = bgHex;

            try {
                const res = await fetch(`/tvstation/channel/${channelId}/qr`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(body),
                });

                const data = await res.json();

                if (data.success) {
                    showToast("Magic code updated!", "success");
                } else {
                    showToast(data.message || "Failed to update magic code", "error");
                }
            } catch (err) {
                console.error("QR update error:", err);
                showToast("Something went wrong", "error");
            }
        }
    </script>



    <script>
        async function downloadMagicCode(channelId, sessionId, isUpdate = false) {
            const fgHex = document.getElementById("selectedFgHex").value;
            const bgHex = document.getElementById("selectedBgHex").value;

            const loader = document.getElementById("loader");
            loader.style.display = "flex"; // show loader

            try {
                // Fetch QR data from server
                const res = await fetch(`/tvstation/channel/${channelId}/session/${sessionId}/qr`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ qrDotColor: fgHex, backgroundColor: bgHex, type: "quiz" }),
                });


                const data = await res.json();
                if (!data.success) {
                    showToast(data.message || "Failed to fetch QR data", "error");
                    return;
                }






                const qrData = data.qr;
                const qrUrl = qrData.redirectUrl;
                const qrCode = new QRCodeStyling({
                    width: 3000,
                    height: 3000,
                    type: "canvas",
                    data: qrUrl,
                    dotsOptions: {
                        color: qrData.qrDotColor || "#000000",
                        type: qrData.dotStyle || "square",
                        gradient: qrData.applyGradient === "linear" ? {
                            type: "linear",
                            colorStops: [
                                { offset: 0, color: "#ff0000" },
                                { offset: 1, color: qrData.qrDotColor || "#000000" }
                            ]
                        } : qrData.applyGradient === "radial" ? {
                            type: "radial",
                            colorStops: [
                                { offset: 0, color: "#ff0000" },
                                { offset: 1, color: qrData.qrDotColor || "#000000" }
                            ]
                        } : null
                    },
                    backgroundOptions: {
                        color: qrData.backgroundColor || "#FFFFFF"
                    },
                    cornersSquareOptions: {
                        type: qrData.cornerStyle || "square"
                    },
                    image: window.location.origin ? `${window.location.origin}/images/logo1.jpg` : "",
                    imageOptions: {
                        crossOrigin: "anonymous",
                        margin: 10
                    }
                });

                const container = document.getElementById("qr-download-container");
                container.innerHTML = ""; // clear previous

                await qrCode.append(container);

                // ⛔ Early return for update (skip download)
                if (isUpdate) {
                    return;
                }

                setTimeout(() => {
                    qrCode.download({ name: "magic-code", extension: "png", width: 1600, height: 1600 });
                }, 500); // wait a little for QR to render
            } catch (error) {
                console.error("Download error:", error);
                showToast("Error downloading magic code", "error");
            }
            finally {
                loader.style.display = "none";
            }
        }
    </script>





    <script>
        const sessionId = "<%= sessionId %>";
        const qrType = "quiz"; // or dynamically pass from backend

        async function loadMagicCodeOnPageLoad(sessionId, type) {
            const loader = document.getElementById("loader");
            loader.style.display = "flex"; // show loader
            try {
                const res = await fetch(`/tvstation/session/${sessionId}/qr/${type}`);
                const data = await res.json();

                if (!data.success) {
                    console.error(data.message || "Failed to fetch QR details");
                    return;
                }

                const qrData = data.data.qr;
                const qrUrl = qrData.redirectUrl;

                const qrCode = new QRCodeStyling({
                    width: 3000,
                    height: 3000,
                    type: "canvas",
                    data: qrUrl,
                    dotsOptions: {
                        color: qrData.qrDotColor || "#000000",
                        type: qrData.dotStyle || "square",
                        gradient: qrData.applyGradient === "linear" ? {
                            type: "linear",
                            colorStops: [
                                { offset: 0, color: "#ff0000" },
                                { offset: 1, color: qrData.qrDotColor || "#000000" }
                            ]
                        } : qrData.applyGradient === "radial" ? {
                            type: "radial",
                            colorStops: [
                                { offset: 0, color: "#ff0000" },
                                { offset: 1, color: qrData.qrDotColor || "#000000" }
                            ]
                        } : null
                    },
                    backgroundOptions: {
                        color: qrData.backgroundColor || "#FFFFFF"
                    },
                    cornersSquareOptions: {
                        type: qrData.cornerStyle || "square"
                    },
                    image: `${window.location.origin}/images/logo1.jpg` || "",
                    imageOptions: {
                        crossOrigin: "anonymous",
                        margin: 10
                    }
                });

                const container = document.getElementById("qr-download-container");
                container.innerHTML = ""; // clear previous QR
                await qrCode.append(container);
            } catch (error) {
                console.error("Error loading magic code:", error);
            }
            finally {
                loader.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadMagicCodeOnPageLoad(sessionId, qrType);
        });
    </script>





</body>

</html>