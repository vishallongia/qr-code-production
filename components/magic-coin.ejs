<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subscription Plans</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="/css/magic-plans.css" rel="stylesheet">
</head>

<body>
    <div class="container" style="margin-top: 10px;">
        <% if (needsCurrencySelection) { %>
            <div style="display:flex; justify-content: end; margin: 10px 0px;">
                <select id="currencySwitcherApp" class="language-selector-select active"
                    style="width: 100%; max-width: 280px;">
                    <option value="EUR" <%=activeCurrency==='EUR' ? 'selected' : '' %>>EUR</option>
                    <option value="CHF" <%=activeCurrency==='CHF' ? 'selected' : '' %>>CHF</option>
                    <option value="HUF" <%=activeCurrency==='HUF' ? 'selected' : '' %>>HUF</option>
                </select>
            </div>
            <% } %>
                <div class="container-custom-wallet">
                    <span class="label">Total Coins</span>
                    <div class="wallet-balance" id="walletBalance">
                        <%= totalMagicCoins %> Magic Coins
                    </div>
                </div>

                <div class="plans">
                    <% plans.forEach(plan=> {
                        const sanitizedId = plan.encryptedId.replace(/[^a-zA-Z0-9-_]/g, ""); // Remove special
                        %>

                        <div class="plan-card">
                            <div class="plan-price" id="plan-price-<%= sanitizedId %>">
                                <%= plan.price %>
                                    <%= plan.currency || "CHF" %>
                            </div>

                            <div class="plan-coins">
                                <%= plan.coinsOffered %> Magic Coins
                            </div>
                            <% if (needsCurrencySelection) { %>
                                <button id="lock-curreny-button-<%= plan.encryptedId %>"
                                    class="lock-curreny-button subscribe-btn  btn"
                                    data-plan-id="<%= plan.encryptedId %>"
                                    style="margin-bottom: 10px; background-color: #1a0161; color:#FFFF;"
                                    onClick="showCurrencyPopup('<%= plan.encryptedId %>')">
                                    Proceed to pay
                                </button>
                                <% } %>
                                    <div id="paypal-button-container-<%= sanitizedId %>" class="paypal-button-container"
                                        style="margin-top: 20px; <%= needsCurrencySelection ? 'display:none;' : 'display:block;' %>"
                                        data-plan-id="<%= plan.encryptedId %>">

                                    </div>
                        </div>
                        <% }) %>
                </div>
    </div>

    <div class="transaction-bar" style="margin-top: 40px;">
        <h3 class="transaction-heading">Magic Coin Transaction History</h3>
        <div class="transaction-list" id="transactionList">
            <% if (transactionHistory && transactionHistory.length> 0) { %>
                <div class="transaction-item header">
                    <span>Coin</span>
                    <span>Type</span>
                    <span>Date</span>
                </div>
                <% transactionHistory.forEach(tx=> {
                    const formattedDate = new Date(tx.createdAt).toLocaleString("en-GB", {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                    });
                    let amountClass = '';
                    let typeText = '';
                    let typeBadgeClass = '';
                    let coinSymbol = ''; // + or -

                    // Set classes and text based on status
                    if (tx.paymentStatus === 'completed') {
                    amountClass = 'balance-added';
                    typeText = 'GAINED';
                    typeBadgeClass = 'badge-added';
                    coinSymbol = '+';
                    }

                    else if (tx.paymentStatus === 'deducted') {
                    amountClass = 'balance-deducted';
                    typeText = 'USED';
                    typeBadgeClass = 'badge-deducted';
                    coinSymbol = '-';
                    }
                    else if (tx.paymentStatus === 'denied' || tx.paymentStatus === 'failed') {
                    amountClass = 'negative';
                    typeText = 'Failed';
                    typeBadgeClass = 'badge-failed';
                    }

                    else {
                    amountClass = '';
                    typeText = 'Pending';
                    typeBadgeClass = 'badge-pending';
                    }
                    %>
                    <div class="transaction-item">
                        <span class="transaction-balance <%= amountClass %>">
                            <%= coinSymbol %>
                                <%= tx.coinsOffered %>
                                    <span class="coin-badge">🪙</span>
                        </span>

                        <span class="transaction-type">
                            <span class="type-badge <%= typeBadgeClass %>">
                                <%= typeText %>
                            </span>
                        </span>

                        <span class="transaction-date">
                            <%= formattedDate %>
                        </span>
                    </div>
                    <% }) %>
                        <% } else { %>
                            <div class="transaction-item">
                                <span class="no-transactions">No transactions available.</span>
                            </div>
                            <% } %>
        </div>
        <% if (hasMore) { %>
            <button id="loadMoreBtn">Load More</button>
            <% } %>
    </div>





</body>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
<script src="/js/toastify-setup.js"></script>
<script
    src="https://www.paypal.com/sdk/js?client-id=AeUlyT2WmljAHqGaXytGewyz61xmfAJ4woW1wA_2TwjcaqbbjJTkPHy47FsEJhcH68BGlm9-AdDfmbrU&currency=<%= currency %>"></script>
<!-- <script src="/js/plan.js"></script> -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const containers = document.querySelectorAll(".paypal-button-container");
        // Initialize the global object to store meta tokens if not already present
        window.paypalMetaTokens = window.paypalMetaTokens || {};


        containers.forEach(container => {
            const planId = container.dataset.planId;
            const sanitizedId = container.id.replace("paypal-button-container-", "");
            // Get the related coupon input field using the plan ID
            const couponInput = document.querySelector(`#coupon-code-${sanitizedId}`);
            // Grab selected currency from the dropdown
            const currencySelect = document.getElementById("currencySwitcherApp");
            const selectedCurrency = currencySelect ? currencySelect.value : '<%= activeCurrency %>'; // fallback to server value

            paypal.Buttons({
                createOrder: function () {
                    return fetch("/paypal/create-order", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ planId, isMagicPlan: true, currency: selectedCurrency })
                    })
                        .then(async res => {
                            if (!res.ok) {
                                const errorData = await res.json();
                                console.log(errorData)
                                throw new Error(errorData.error || "Failed to create order");
                            }
                            return res.json();
                        })
                        .then(data => {
                            // Check if a success message exists
                            if (data.message) {
                                // Show success message
                                showToast(data.message, "success");
                                if (couponInput) couponInput.value = ""; // Clear the coupon input
                                // Reload the page after 3 seconds (to allow time for the toast to show)
                                setTimeout(() => {
                                    location.reload(); // Reload the page
                                }, 2000); // 3000 ms (3 seconds) delay before reload

                            }
                            // Store metaToken indexed by order ID for later use in capture
                            if (data.id && data.metaToken) {
                                window.paypalMetaTokens[data.id] = data.metaToken;
                            }
                            return data.id;
                        })
                        .catch(err => {
                            console.error("Create Order Error:", err);
                            showToast(err.message || "An error occurred while creating the order", "error");
                            if (couponInput) couponInput.value = ""; // Clear the coupon input
                            throw err; // rethrow so PayPal knows it failed
                        });
                },
                onApprove: function (data) {
                    const metaToken = window.paypalMetaTokens[data.orderID];
                    return fetch("/paypal/capture-order", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            orderID: data.orderID,
                            planId,
                            metaToken,
                            isMagicPlan: true
                        })
                    })
                        .then(res => res.json())
                        .then(response => {
                            // Clear the metaToken no matter what
                            delete window.paypalMetaTokens[data.orderID];
                            if (response.status === 'COMPLETED') {

                                if (response.transactionId) {
                                    if (couponInput) couponInput.value = ""; // Clear the coupon input
                                    // ✅ Redirect to success page with transaction ID
                                    const type = "magic"; // or whatever type you need
                                    window.location.href = `/successpayment?session_id=${response.transactionId}&type=${type}`
                                } else {
                                    alert("Transaction ID not found.");
                                }
                            } else {
                                showToast(response.message, "error");
                                setTimeout(() => {
                                    window.location.href = `/cancel`;
                                }, 1000); // 1000 milliseconds = 1 second delay
                            }
                        });
                },
                onError: function (err) {
                    // Also clear in case of error to avoid memory leaks
                    delete window.paypalMetaTokens[data.orderID];
                    console.log(err)
                    console.error("PayPal Button Error:", err);
                    // showToast("An error occurred during the transaction.", "error");
                }
            }).render(container);
        });
    });


    let skipCount = <%= transactionHistory.length %>; // can keep if first batch is correct


    const loadMoreBtn = document.getElementById("loadMoreBtn");
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener("click", async () => {
            try {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = "Loading...";

                // Use limit of 5, as in your original JS.
                const response = await fetch(`/magic-coin-wallet?skip=${skipCount}&limit=5`, {
                    headers: { Accept: "application/json" }
                });
                const data = await response.json();

                data.transactionHistory.forEach((tx) => {
                    const item = document.createElement("div");
                    item.className = "transaction-item";

                    const formattedDate = new Date(tx.createdAt).toLocaleString("en-GB", {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    let amountClass = '';
                    let typeText = '';
                    let typeBadgeClass = '';
                    let coinSymbol

                    // Match the backend logic for paymentStatus
                    if (tx.paymentStatus === 'completed') {
                        amountClass = 'balance-added';
                        typeText = 'GAINED';
                        typeBadgeClass = 'badge-added';
                        coinSymbol = '+';
                    } else if (tx.paymentStatus === 'denied' || tx.paymentStatus === 'failed') {
                        amountClass = 'negative';
                        typeText = 'Failed';
                        typeBadgeClass = 'badge-failed';

                    }

                    else if (tx.paymentStatus === 'deducted') {
                        amountClass = 'balance-deducted';
                        typeText = 'USED';
                        coinSymbol = '-';
                        typeBadgeClass = 'badge-deducted';
                    } else {
                        amountClass = '';
                        typeText = 'Pending';
                        typeBadgeClass = 'badge-pending';
                    }
                    item.innerHTML = `
    <span class="transaction-balance ${amountClass}">
        ${coinSymbol}${tx.coinsOffered}
        <span class="coin-badge">🪙</span>
    </span>
    <span class="transaction-type">
        <span class="type-badge ${typeBadgeClass}">${typeText}</span>
    </span>     
    <span class="transaction-date">
        ${formattedDate}
    </span>
`;

                    document.getElementById("transactionList").appendChild(item);
                });

                skipCount += data.transactionHistory.length;

                if (!data.hasMore) {
                    loadMoreBtn.remove();
                } else {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = "Load More";
                }
            } catch (err) {
                console.error("Load more failed", err);
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = "Load More"; // Re-enable button on error
            }
        });
    }

</script>


<script>
    document.getElementById("currencySwitcherApp").addEventListener("change", function () {
        const url = new URL(window.location);
        url.searchParams.set("currency", this.value);
        window.location = url;
    });
    function showCurrencyPopup(planId) {
        const popup = document.getElementById("theme-popup-select-currency");
        const okBtn = document.getElementById("popup-ok-btn-select-currency");
        const cancelBtn = document.getElementById("popup-cancel-btn-select-currency");
        const currencySelect = document.getElementById("currencySwitcherApp"); // the select
        const loader = document.getElementById("loader");

        popup.style.display = "flex";

        const cleanup = () => {
            popup.style.display = "none";
            okBtn.onclick = null;
            cancelBtn.onclick = null;
        };

        okBtn.onclick = async (e) => {
            e.preventDefault();

            const selectedCurrency = currencySelect.value;

            // Frontend mandatory check
            if (!selectedCurrency) {
                return showToast("Please select a currency!", "error");
            }

            loader.style.display = "flex"; // show loader

            try {
                // 1️⃣ Call backend to set currency
                const res = await fetch("/set-currency", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ currency: selectedCurrency })
                });
                const data = await res.json();

                if (!res.ok) {
                    return showToast(data.message || "Failed to set currency", "error");
                }

                showToast(data.message || "Currency set successfully", "success");

                // 2️⃣ Continue with your logic: show PayPal buttons
                const allPaypalContainers = document.querySelectorAll(".paypal-button-container");
                allPaypalContainers.forEach(container => container.style.display = "block");

                const allLockCurrencyButtons = document.querySelectorAll(".lock-curreny-button");
                allLockCurrencyButtons.forEach(btn => btn.style.display = "none");

                currencySelect.style.display = "none";

                // Optional: call your renderPayPalButtons(planId) if needed
                // renderPayPalButtons(planId);

                cleanup(); // hide popup

            } catch (err) {
                console.error("Error setting currency:", err);
                showToast("Internal error. Please try again.", "error");
            } finally {
                loader.style.display = "none"; // hide loader
            }
        };

        cancelBtn.onclick = (e) => {
            e.preventDefault();
            cleanup();
        };
    }
</script>





</html>