<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz</title>
    <link rel="stylesheet" href="/css/user-quiz.css" />
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
</head>

<body class="user-quiz-page">

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
    </div>

    <div class="coin-popup-overlay" id="coinPopup" style="display: none;">
        <div class="coin-popup">
            <% if (currentQuestion?.mode==="jackpot" || currentQuestion?.mode==="both" ) { %>
                <div>
                    <h3>Confirm Answer</h3>
                    <p id="selectedOptionText"></p> <!-- ‚úÖ Option text will be shown here -->

                    <% if (currentQuestion?.jackpotCoinDeducted) { %>
                        <p>Do you want to compete for the jackpot for <%= currentQuestion.jackpotCoinDeducted %> coins?
                        </p>

                        <% } %>

                            <% if (currentQuestion?.jackpotRewardName) { %>
                                <p>üéÅ <%= currentQuestion.jackpotRewardName %>
                                </p>
                                <% } %>

                                    <% if (currentQuestion?.jackpotRewardImage) { %>
                                        <div style="margin:15px 0px;">
                                            <img src="<%= currentQuestion.jackpotRewardImage %>" alt="Jackpot Reward">
                                        </div>
                                        <% } %>

                                            <% if (currentQuestion?.jackpotRewardDescription) { %>
                                                <p>
                                                    <%= currentQuestion.jackpotRewardDescription %>
                                                </p>
                                                <% } %>

                                                    <% if (currentQuestion?.jackpotCoinDeducted) { %>

                                                        <label class="coin-toggle">
                                                            <input type="checkbox" id="deductJackpotCoinSwitch" checked>
                                                            <span class="slider"></span>
                                                            Deduct Coins
                                                        </label>
                                                        <% } %>
                </div>
                <% } %>

                    <% if (currentQuestion?.mode==="digital" || currentQuestion?.mode==="both" ) { %>
                        <div>


                            <% if (currentQuestion?.digitalCoinDeducted) { %>
                                <p>Do you want to compete for the digital reward for <%=
                                        currentQuestion.digitalCoinDeducted %> coins?</p>
                                <% } %>

                                    <% if (currentQuestion?.digitalRewardName) { %>
                                        <p>üéÅ <%= currentQuestion.digitalRewardName %>
                                        </p>
                                        <% } %>

                                            <% if (currentQuestion?.digitalRewardImage) { %>
                                                <div style="margin:15px 0px;">
                                                    <img src="<%= currentQuestion.digitalRewardImage %>"
                                                        alt="Digital Reward">
                                                </div>
                                                <% } %>

                                                    <% if (currentQuestion?.digitalRewardDescription) { %>
                                                        <p>
                                                            <%= currentQuestion.digitalRewardDescription %>
                                                        </p>
                                                        <% } %>

                                                            <% if (currentQuestion?.digitalCoinDeducted) { %>
                                                                <label class="coin-toggle">
                                                                    <input type="checkbox" id="deductDigitalCoinSwitch"
                                                                        checked>
                                                                    <span class="slider"></span>
                                                                    Deduct Coins
                                                                </label>
                                                                <% } %>
                        </div>
                        <% } %>

                            <div class="coin-popup-buttons">
                                <button onclick="confirmAnswer(true)">Submit</button>
                                <button onclick="closeCoinPopup()">Cancel</button>
                            </div>
        </div>
    </div>
    <div class="uq-header">
        <div class="uq-logo">Magic Code</div>
        <div class="uq-coins">ü™ô Magic Coins: <%= availableCoins || 0 %>
        </div>
    </div>

    <div class="uq-container">
        <% if (currentQuestion) { %>
            <form action="/submit-answer" method="POST">
                <input type="hidden" name="channelId" value="<%= channel._id %>">
                <input type="hidden" name="questionId" value="<%= currentQuestion._id %>">
                <input type="hidden" name="index" value="<%= index %>">

                <div class="uq-question-header">
                    <% if (currentQuestion.logo) { %>
                        <% if (currentQuestion.logoLink) { %>
                            <a href="<%= currentQuestion.logoLink %>" target="_blank">
                                <img class="uq-question-logo" src="<%= currentQuestion.logo %>" alt="Logo" />
                            </a>
                            <% } else { %>
                                <img class="uq-question-logo" src="<%= currentQuestion.logo %>" alt="Logo" />
                                <% } %>

                                    <% if (currentQuestion.logoTitle || currentQuestion.logoDescription) { %>
                                        <div class="uq-logo-text">
                                            <% if (currentQuestion.logoTitle) { %>
                                                <h4 class="uq-logo-title">
                                                    <%= currentQuestion.logoTitle %>
                                                </h4>
                                                <% } %>
                                                    <% if (currentQuestion.logoDescription) { %>
                                                        <p class="uq-logo-text">
                                                            <%= currentQuestion.logoDescription %>
                                                        </p>
                                                        <% } %>
                                        </div>
                                        <% } %>
                                            <% } %>
                </div>


                <!-- Question Header -->
                <div class="uq-question-header">
                    <% if (currentQuestion.questionLogo) { %>
                        <% if (currentQuestion.questionImageLink) { %>
                            <a href="<%= currentQuestion.questionImageLink %>" target="_blank">
                                <img class="uq-question-logo" src="<%= currentQuestion.questionLogo %>"
                                    alt="Question Logo" />
                            </a>
                            <% } else { %>
                                <img class="uq-question-logo" src="<%= currentQuestion.questionLogo %>"
                                    alt="Question Logo" />
                                <% } %>
                                    <% } %>
                </div>


                <!-- Question Text -->
                <div class="uq-question-number">Question <%= index + 1 %> of <%= total %>
                </div>
                <div class="uq-question-text">
                    <%= currentQuestion.question %>
                </div>

                <!-- Move Question Image BELOW the text -->
                <% if (currentQuestion.questionImage) { %>
                    <div class="uq-question-image-wrapper">
                        <a href="<%= currentQuestion.questionImageLink || '#' %>" target="_blank">
                            <img class="uq-question-image" src="<%= currentQuestion.questionImage %>"
                                alt="Question Image" />
                        </a>
                    </div>
                    <% } %>

                        <!-- Options -->
                        <div class="uq-options">
                            <% currentQuestion.options.forEach((opt, i)=> { %>
                                <div class="uq-option">
                                    <input type="radio" name="selectedOptionIndex" id="opt<%= i %>" value="<%= i %>">
                                    <label for="opt<%= i %>">
                                        <% if (opt.image) { %>
                                            <img class="uq-option-inline-image" src="<%= opt.image %>"
                                                alt="Option Image" />
                                            <% } %>
                                                <span>
                                                    <%= opt.text %>
                                                </span>
                                    </label>
                                </div>
                                <% }) %>
                        </div>

                        <!-- Navigation -->
                        <% const prevIndex=index> 0 ? index - 1 : 0; %>
                            <% const nextIndex=index + 1 < total ? index + 1 : index; %>

                                <!-- <div class="uq-navigation">
                                    <button type="button" onclick="window.location.href='?index=<%= prevIndex %>'" <% if
                                        (index <=0) { %> disabled <% } %>>Back</button>
                                    <button type="button" onclick="window.location.href='?index=<%= nextIndex %>'" <% if
                                        (index + 1>= total) { %> disabled <% } %>>Next</button>
                                </div> -->
            </form>
            <% } else { %>
                <p>
                    <%= error || "No question found or quiz ended." %>
                </p>
                <% } %>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
<script src="/js/toastify-setup.js"></script>
<script>
    let selectedOptionIndex = null;

    const options = document.querySelectorAll('input[name="selectedOptionIndex"]');
    const coinPopup = document.getElementById("coinPopup");
    const deductCoinSwitch = document.getElementById("deductCoinSwitch");

    // Capture selected option and open popup
    options.forEach((opt) => {
        opt.addEventListener("change", (e) => {
            selectedOptionIndex = parseInt(e.target.value);
            openCoinPopup();
        });
    });

    function openCoinPopup() {
        const selectedRadio = document.querySelector('input[name="selectedOptionIndex"]:checked');
        const label = document.querySelector(`label[for="${selectedRadio.id}"]`);
        const optionLetter = String.fromCharCode(65 + parseInt(selectedRadio.value)); // 65 = A, 66 = B, etc.

        const optionTextEl = document.getElementById("selectedOptionText");
        optionTextEl.textContent = `You selected option ${optionLetter}: "${label.innerText.trim()}"`;

        coinPopup.style.display = "flex";
    }


    function closeCoinPopup() {
        coinPopup.style.display = "none";
        selectedOptionIndex = null;
        // Optional: Unselect the radio if popup is canceled
        const selected = document.querySelector('input[name="selectedOptionIndex"]:checked');
        if (selected) selected.checked = false;
    }

    function confirmAnswer() {
        const questionId = document.querySelector('input[name="questionId"]').value;
        const channelId = document.querySelector('input[name="channelId"]').value;
        // const deductCoin = deductCoinSwitch.checked;

        // Check which toggles are ON
        const deductJackpotCoin = document.getElementById("deductJackpotCoinSwitch")?.checked || false;
        const deductDigitalCoin = document.getElementById("deductDigitalCoinSwitch")?.checked || false;

        const loader = document.getElementById("loader");
        loader.style.display = "flex"; // show loader

        fetch("/tvstation/quiz-response", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                questionId,
                channelId,
                selectedOptionIndex,
                deductCoin: deductJackpotCoin || deductDigitalCoin, // overall deduction
                jackpotCoinDeducted: deductJackpotCoin,
                digitalCoinDeducted: deductDigitalCoin
            }),
        })
            .then((res) => res.json())
            .then((data) => {
                if (data.success) {
                    showToast(
                        data.isCorrect ? "Correct Answer!" : "Wrong Answer!",
                        data.isCorrect ? "success" : "error"
                    );
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast(data.message || "Failed to save response", "error");
                }
            })
            .catch((err) => {
                console.error(err);
                showToast("Something went wrong", "error");
            })
            .finally(() => {
                closeCoinPopup();
                loader.style.display = "none"; // hide loader after fetch is done
            });
    }
</script>


</html>