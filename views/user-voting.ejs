<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Magic Voting</title>
    <link rel="stylesheet" href="/css/user-quiz.css" />
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="192x192" href="/app-icon-192.png">
</head>

<body class="user-quiz-page">

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Result Popup -->
    <div class="coin-popup-overlay" id="resultPopup" style="display: none;">
        <div class="coin-popup">
            <div class="coin-popup-inner">
                <p id="resultText" style="font-size: 1.5rem; font-weight: bold;"></p>
                <div id="jackpotRewardSection" style="display: none; margin: 15px 0;">
                    <img id="jackpotRewardImage" src="" alt="Jackpot Reward" />
                    <p id="jackpotRewardDescription" style="font-size: 0.95rem;"></p>
                </div>
                <div id="digitalRewardSection" style="display: none; margin: 15px 0;">
                    <img id="digitalRewardImage" src="" alt="Digital Reward" />
                    <p id="digitalRewardDescription" style="font-size: 0.95rem;"></p>
                </div>
                <div class="coin-popup-buttons">
                    <button onclick="closeResultPopup()">Ok</button>
                    <button id="top-up-wallet" onclick="window.location.href='/magic-coin-wallet'"
                        style="display: none;">Top Up
                        Wallet</button>
                </div>
            </div>
        </div>
    </div>

    <div class="coin-popup-overlay" id="coinPopup" style="display: none;">
        <div class="coin-popup">
            <div class="coin-popup-inner">
                <% if (currentQuestion?.mode==="jackpot" || currentQuestion?.mode==="both" ||
                    currentQuestion?.mode==="none" || currentQuestion?.mode==="digital" ) { %>
                    <div class="jackpot-parent-div">
                        <!-- <h3>Confirm Answer</h3> -->
                        <p id="selectedOptionText"></p> <!-- ‚úÖ Option text will be shown here -->

                        <% if (currentQuestion?.jackpotCoinDeducted) { %>
                            <p><span data-translate="doYouWantToCompeteForTheJackpotFor">Do you want to compete for the
                                    jackpot for</span>
                                <%= currentQuestion.jackpotCoinDeducted %>
                                    <span data-translate="coins">coins</span>?
                            </p>

                            <% } %>

                                <% if (currentQuestion?.jackpotRewardName) { %>
                                    <p class="reward-name-highlighter">üéÅ <%= currentQuestion.jackpotRewardName %>
                                    </p>
                                    <% } %>

                                        <% if (currentQuestion?.jackpotRewardImage) { %>
                                            <div style="margin:15px 0px;">
                                                <% if (currentQuestion.jackpotRewardLink) { %>
                                                    <a href="<%= currentQuestion.jackpotRewardLink %>" target="_blank"
                                                        rel="noopener noreferrer">
                                                        <img src="<%= currentQuestion.jackpotRewardImage %>"
                                                            alt="Jackpot Reward">
                                                    </a>
                                                    <% } else { %>
                                                        <img src="<%= currentQuestion.jackpotRewardImage %>"
                                                            alt="Jackpot Reward">
                                                        <% } %>
                                            </div>
                                            <% } %>


                                                <% if (currentQuestion?.jackpotRewardDescription) { %>
                                                    <p style="font-size: 0.95rem;">
                                                        <%= currentQuestion.jackpotRewardDescription %>
                                                    </p>
                                                    <% } %>
                    </div>
                    <% if (currentQuestion?.jackpotCoinDeducted) { %>

                        <label class="coin-toggle">
                            <span data-translate="no">NO</span>
                            <input type="checkbox" id="deductJackpotCoinSwitch" checked>
                            <span class="slider"></span>
                            <span data-translate="yes">Yes</span>
                        </label>
                        <% } %>
                            <% } %>

                                <% if (currentQuestion?.mode==="digital" || currentQuestion?.mode==="both" ) { %>
                                    <div class="digital-parent-div">


                                        <% if (currentQuestion?.digitalCoinDeducted) { %>
                                            <p><span
                                                    data-translate="doYouWantToWinTheSpecialPriceFreeVipPlanFor3MonthsFor">Do
                                                    you want to compete for the digital reward for</span>
                                                <%= currentQuestion.digitalCoinDeducted %> <span
                                                        data-translate="coins">coins</span>?
                                            </p>
                                            <% } %>

                                                <% if (currentQuestion?.digitalRewardName) { %>
                                                    <p class="reward-name-highlighter">üéâ <%=
                                                            currentQuestion.digitalRewardName %>
                                                    </p>
                                                    <% } %>

                                                        <% if (currentQuestion?.digitalRewardImage) { %>
                                                            <div style="margin:15px 0px;">
                                                                <% if (currentQuestion.digitalRewardLink) { %>
                                                                    <a href="<%= currentQuestion.digitalRewardLink %>"
                                                                        target="_blank" rel="noopener noreferrer">
                                                                        <img src="<%= currentQuestion.digitalRewardImage %>"
                                                                            alt="Digital Reward">
                                                                    </a>
                                                                    <% } else { %>
                                                                        <img src="<%= currentQuestion.digitalRewardImage %>"
                                                                            alt="Digital Reward">
                                                                        <% } %>
                                                            </div>
                                                            <% } %>


                                                                <% if (currentQuestion?.digitalRewardDescription) { %>
                                                                    <p style="font-size: 0.95rem;">
                                                                        <%= currentQuestion.digitalRewardDescription %>
                                                                    </p>
                                                                    <% } %>


                                    </div>
                                    <% if (currentQuestion?.digitalCoinDeducted) { %>
                                        <label class="coin-toggle">
                                            <span data-translate="no">No</span>
                                            <input type="checkbox" id="deductDigitalCoinSwitch" checked>
                                            <span class="slider"></span>
                                            <span data-translate="yes">Yes</span>
                                        </label>
                                        <% } %>
                                            <% } %>

                                                <div class="coin-popup-buttons">
                                                    <button onclick="confirmAnswer(true)">Ok</button>
                                                    <button onclick="closeCoinPopup()"
                                                        style="display: none;">Cancel</button>
                                                </div>
            </div>
        </div>
    </div>
    <input type="hidden" name="sessionId" value="<%= sessionId %>">
    <div class="uq-header">
        <div class="uq-logo" onclick="window.location.href='/'">Magic Voting</div>
        <div class="uq-coins" id="walletCoins" onclick="window.location.href='/magic-coin-wallet'">
            ü™ô Magic Coins: <%= availableCoins || 0 %>
        </div>

    </div>
    </div>

    <div class="language-selector-container">
        <select id="languageSwitcher" class="language-selector-select">
            <option value="en">English</option>
            <option value="de">Deutsch (German)</option>
            <option value="hu">Hungarian</option>
            <option value="ro">Romanian</option>
        </select>
    </div>

    <div class="uq-container">
        <% if (currentQuestion) { %>
            <form action="/submit-answer" method="POST">
                <input type="hidden" name="channelId" value="<%= channel._id %>">
                <input type="hidden" name="questionId" value="<%= currentQuestion._id %>">
                <input type="hidden" name="index" value="<%= index %>">

                <div class="uq-question-header">
                    <% if (currentQuestion.logo) { %>
                        <% if (currentQuestion.logoLink) { %>
                            <a href="<%= currentQuestion.logoLink %>" target="_blank">
                                <img class="uq-question-logo" src="<%= currentQuestion.logo %>" alt="Logo" />
                            </a>
                            <% } else { %>
                                <img class="uq-question-logo" src="<%= currentQuestion.logo %>" alt="Logo" />
                                <% } %>

                                    <% if (currentQuestion.logoTitle || currentQuestion.logoDescription) { %>
                                        <div class="uq-logo-text" style="    width: 100%; text-align: center;">
                                            <% if (currentQuestion.logoTitle) { %>
                                                <h4 class="uq-logo-title" style="font-size: 1.4rem; font-weight: 600;">
                                                    <%= currentQuestion.logoTitle %>
                                                </h4>
                                                <% } %>
                                                    <% if (currentQuestion.logoDescription) { %>
                                                        <p class="uq-logo-text"
                                                            style="font-size: 1.2rem; font-weight: 500;">
                                                            <%= currentQuestion.logoDescription %>
                                                        </p>
                                                        <% } %>
                                        </div>
                                        <% } %>
                                            <% } %>
                </div>


                <!-- Question Header -->
                <div class="uq-question-header">
                    <% if (currentQuestion.questionLogo) { %>
                        <% if (currentQuestion.questionImageLink) { %>
                            <a href="<%= currentQuestion.questionImageLink %>" target="_blank">
                                <img class="uq-question-logo" src="<%= currentQuestion.questionLogo %>"
                                    alt="Question Logo" />
                            </a>
                            <% } else { %>
                                <img class="uq-question-logo" src="<%= currentQuestion.questionLogo %>"
                                    alt="Question Logo" />
                                <% } %>
                                    <% } %>
                </div>


                <!-- Question Text -->
                <!-- <div class="uq-question-number">Question <%= index + 1 %> of <%= total %>
                </div> -->


                <!-- Move Question Image BELOW the text -->
                <% if (currentQuestion.questionImage) { %>
                    <div class="uq-question-image-wrapper">
                        <% if (currentQuestion.questionImageLink) { %>
                            <a href="<%= currentQuestion.questionImageLink %>" target="_blank">
                                <img class="uq-question-image" src="<%= currentQuestion.questionImage %>"
                                    alt="Question Image" />
                            </a>
                            <% } else { %>
                                <img class="uq-question-image" src="<%= currentQuestion.questionImage %>"
                                    alt="Question Image" />
                                <% } %>
                    </div>
                    <% } %>
                        <div class="uq-question-text" style="font-size: 1.2rem; font-weight: 500;">
                            <%= currentQuestion.question %>
                        </div>
                        <!-- Options -->
                        <div class="uq-options">
                            <% currentQuestion.options.forEach((opt, i)=> { %>
                                <div class="uq-option">
                                    <label for="opt<%= i %>">
                                        <input type="radio" name="selectedOptionIndex" id="opt<%= i %>"
                                            value="<%= i %>">
                                        <div class="uq-option-text-wrapper"
                                            style="font-size: 1.0rem; font-weight: 600;">
                                            <span class="uq-option-letter">
                                                <%= String.fromCharCode(65 + i) %>.
                                            </span>
                                            <span class="uq-option-text">
                                                <%= opt.text %>
                                            </span>
                                        </div>
                                        <% if (opt.image) { %>
                                            <img class="uq-option-image-large" src="<%= opt.image %>"
                                                alt="Option Image" />
                                            <% } %>

                                                <span class="" style="font-weight: normal;">
                                                    <%= opt.description %>
                                                </span>
                                    </label>
                                    <div class="progress-bar-container" id="barContainer<%= i %>">
                                        <div class="progress-bar-fill" id="bar<%= i %>"
                                            style="width: <%= opt.percentage %>%;">
                                            <%= opt.percentage %>%
                                        </div>
                                    </div>
                                </div>
                                <% }) %>
                        </div>

                        <!-- Navigation -->
                        <% const prevIndex=index> 0 ? index - 1 : 0; %>
                            <% const nextIndex=index + 1 < total ? index + 1 : index; %>

                                <!-- <div class="uq-navigation">
                                    <button type="button" onclick="window.location.href='?index=<%= prevIndex %>'" <% if
                                        (index <=0) { %> disabled <% } %>>Back</button>
                                    <button type="button" onclick="window.location.href='?index=<%= nextIndex %>'" <% if
                                        (index + 1>= total) { %> disabled <% } %>>Next</button>
                                </div> -->
            </form>
            <% } else { %>
                <p>
                    <%= error || "No question found or quiz ended." %>
                </p>
                <% } %>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
<script src="/js/toastify-setup.js"></script>
<script>
    let selectedOptionIndex = null;

    const options = document.querySelectorAll('input[name="selectedOptionIndex"]');
    const coinPopup = document.getElementById("coinPopup");
    const deductCoinSwitch = document.getElementById("deductCoinSwitch");

    // Capture selected option and open popup
    options.forEach((opt) => {
        opt.addEventListener("change", (e) => {
            selectedOptionIndex = parseInt(e.target.value);
            openCoinPopup();
        });
    });

    function updateVoteBars(voteResults) {
        voteResults.forEach(result => {
            const idx = result.optionIndex;
            const barFill = document.getElementById(`bar${idx}`);
            if (barFill) {
                // Animate width smoothly
                barFill.style.transition = "width 0.8s ease-in-out";
                barFill.style.width = `${result.percentage}%`;
                barFill.textContent = `${result.percentage}%`;
            }
        });
    }

    function openCoinPopup() {
        const selectedRadio = document.querySelector('input[name="selectedOptionIndex"]:checked');
        if (!selectedRadio) {
            // If no radio button is selected, exit the function.
            return;
        }

        const label = document.querySelector(`label[for="${selectedRadio.id}"]`);
        const optionLetter = String.fromCharCode(65 + parseInt(selectedRadio.value));

        // Find the span with the class 'uq-option-text' inside the parent div
        const optionTextElInPopup = document.getElementById("selectedOptionText");
        const optionTextSpan = label.closest('.uq-option').querySelector('.uq-option-text');

        if (optionTextSpan) {
            optionTextElInPopup.innerHTML = `<span data-translate="youSelectedOption">You selected option</span> ${optionLetter}, <span data-translate="anwser">anwser</span> "${optionTextSpan.innerText.trim()}".`;
        } else {
            optionTextElInPopup.innerHTML = `<span data-translate="youSelectedOption">You selected option</span> ${optionLetter}: "(text not found)"`;
        }

        coinPopup.style.display = "flex";
    }


    function closeCoinPopup() {
        coinPopup.style.display = "none";
        selectedOptionIndex = null;
        // Optional: Unselect the radio if popup is canceled
        const selected = document.querySelector('input[name="selectedOptionIndex"]:checked');
        if (selected) selected.checked = false;
    }

    function confirmAnswer() {
        const questionId = document.querySelector('input[name="questionId"]').value;
        const channelId = document.querySelector('input[name="channelId"]').value;
        const sessionId = document.querySelector('input[name="sessionId"]').value; // added

        // const deductCoin = deductCoinSwitch.checked;

        // Check which toggles are ON
        const deductJackpotCoin = document.getElementById("deductJackpotCoinSwitch")?.checked || false;
        const deductDigitalCoin = document.getElementById("deductDigitalCoinSwitch")?.checked || false;

        const loader = document.getElementById("loader");
        loader.style.display = "flex"; // show loader

        fetch("/tvstation/voting-response", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                questionId,
                channelId,
                selectedOptionIndex,
                deductCoin: deductJackpotCoin || deductDigitalCoin, // overall deduction
                jackpotCoinDeducted: deductJackpotCoin,
                digitalCoinDeducted: deductDigitalCoin,
                sessionId
            }),
        })
            .then((res) => res.json())
            .then((data) => {
                if (data.success || data.notEnoughCoins) {
                    // Show result popup instead of reloading
                    showResultPopup(data);
                    localStorage.setItem(`voting_response_${questionId}_${sessionId}`, "answered");
                } else {
                    showToast(data.message || "Failed to save response", "error");
                }
            })
            .catch((err) => {
                console.error(err);
                showToast("Something went wrong", "error");
            })
            .finally(() => {
                closeCoinPopup();
                loader.style.display = "none"; // hide loader after fetch is done
            });
    }


    function showResultPopup(data) {
        document.getElementById("top-up-wallet").style.display = "none";
        const resultPopup = document.getElementById("resultPopup");
        const resultText = document.getElementById("resultText");
        const jackpotSection = document.getElementById("jackpotRewardSection");
        const digitalSection = document.getElementById("digitalRewardSection");


        // Reset sections
        jackpotSection.style.display = "none";
        digitalSection.style.display = "none";

        // Extract data
        const selectedLetter = String.fromCharCode(65 + parseInt(data.selectedOptionIndex));
        const result = !data.notEnoughCoins && data.voteResults.find(r => r.optionIndex === data.selectedOptionIndex);
        const percentage = result ? result.percentage : 0;
        const jackpotDeducted = data.jackpotCoinDeducted;
        const digitalDeducted = data.digitalCoinDeducted;




        // Update coin counter in UI if exists
        const walletCoinsEl = document.getElementById("walletCoins");
        if (walletCoinsEl && data.availableCoins !== undefined) {
            walletCoinsEl.textContent = `ü™ô Magic Coins: ${data.availableCoins}`;
        }

        // Check if user had enough coins
        if (data.notEnoughCoins) {
            document.getElementById("top-up-wallet").style.display = "block"
            resultText.innerHTML = `‚ùå You do not have enough coins to participate.<br>
        You have <strong>${data.availableCoins}</strong> coins, but <strong>${data.requiredCoins}</strong> are required.`;
        } else {
            // Show message
            resultText.innerHTML = `<span data-translate="Thankyouforvoting">Thank you for voting</span>. <span data-translate="Option">Option</span> ${selectedLetter} <span data-translate="received">received</span> ${percentage}% <span data-translate="votes">votes</span>.`;
            // Jackpot reward
            if (jackpotDeducted && data.jackpotReward) {
                jackpotSection.style.display = "block";
                const jackpotImage = document.getElementById("jackpotRewardImage");
                const jackpotDesc = document.getElementById("jackpotRewardDescription");

                // Remove old reward name paragraph if exists
                const oldNameEl = jackpotSection.querySelector(".jackpot-name");
                if (oldNameEl) oldNameEl.remove();
                if (data.jackpotReward.name) {
                    const nameEl = document.createElement("p");
                    nameEl.className = "jackpot-name reward-name-highlighter";
                    nameEl.textContent = `üéÅ ${data.jackpotReward.name}`;
                    jackpotSection.insertBefore(nameEl, jackpotImage);
                }

                jackpotImage.src = data.jackpotReward.image || "";
                jackpotDesc.textContent = data.jackpotReward.description || "";

                // Make image clickable if link exists
                if (data.jackpotReward.link) {
                    jackpotImage.style.cursor = "pointer";
                    jackpotImage.onclick = () => window.open(data.jackpotReward.link, "_blank");
                } else {
                    jackpotImage.onclick = null; // normal image
                    jackpotImage.style.cursor = "default";
                }
            }

            // Digital reward
            if (digitalDeducted && data.digitalReward) {
                digitalSection.style.display = "block";
                const digitalImage = document.getElementById("digitalRewardImage");
                const digitalDesc = document.getElementById("digitalRewardDescription");

                // Remove old reward name paragraph if exists
                const oldNameEl = digitalSection.querySelector(".digital-name");
                if (oldNameEl) oldNameEl.remove();

                if (data.digitalReward.name) {
                    const nameEl = document.createElement("p");
                    nameEl.className = "digital-name reward-name-highlighter";
                    nameEl.textContent = `üéÅ ${data.digitalReward.name}`;
                    digitalSection.insertBefore(nameEl, digitalImage);
                }

                digitalImage.src = data.digitalReward.image || "";
                digitalDesc.textContent = data.digitalReward.description || "";

                // Make image clickable if link exists
                if (data.digitalReward.link) {
                    digitalImage.style.cursor = "pointer";
                    digitalImage.onclick = () => window.open(data.digitalReward.link, "_blank");
                } else {
                    digitalImage.onclick = null; // normal image
                    digitalImage.style.cursor = "default";
                }
            }


        }

        // ‚úÖ Immediately update the vote percentages
        if (data.voteResults && data.voteResults.length) {
            updateVoteBars(data.voteResults);
        }

        resultPopup.style.display = "flex";
    }


    function closeResultPopup() {
        document.getElementById("resultPopup").style.display = "none";

    }

</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const questionId = document.querySelector('input[name="questionId"]').value;
        const channelId = document.querySelector('input[name="channelId"]').value;
        const sessionId = document.querySelector('input[name="sessionId"]').value;

        const responseKey = `voting_response_${questionId}_${sessionId}`; // changed
        const landKey = `voting_land_${questionId}_${sessionId}`;         // changed

        // Reset answer state here
        if (localStorage.getItem(responseKey) === "answered") {
            localStorage.setItem(responseKey, "never");
        }

        // First visit: mark response state if not present
        if (!localStorage.getItem(responseKey)) {
            localStorage.setItem(responseKey, "never");
        }

        // Mark session land
        if (!sessionStorage.getItem(landKey)) {
            sessionStorage.setItem(landKey, "visited");
        }

        // Fire Beacon only on unload if unanswered AND it‚Äôs not the first land
        window.addEventListener("beforeunload", () => {
            if (
                localStorage.getItem(responseKey) === "never" &&
                sessionStorage.getItem(landKey) === "visited"
            ) {
                const payload = JSON.stringify({
                    questionId,
                    channelId,
                    sessionId,
                    type: "voting" // changed
                });

                if (navigator.sendBeacon) {
                    const blob = new Blob([payload], { type: "application/json" });
                    navigator.sendBeacon("/tvstation/quiz-viewed", blob);
                } else {
                    fetch("/tvstation/quiz-viewed", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: payload
                    })
                        .catch(err => console.error("Error recording viewed-only response:", err));
                }
            }
        });
    });
</script>


<script>
    const langSelector = document.querySelector('.language-selector-select');
    const selectedLang = document.querySelector('.selected-lang');
    const dropdownItems = document.querySelectorAll('.language-dropdown li');

    langSelector.addEventListener('click', () => {
        langSelector.classList.toggle('active');
    });

    dropdownItems.forEach(item => {
        item.addEventListener('click', (e) => {
            const lang = e.target.getAttribute('data-lang');
            selectedLang.textContent = lang;
            langSelector.classList.remove('active');
        });
    });

    // Optional: Click outside to close dropdown
    document.addEventListener('click', (e) => {
        if (!langSelector.contains(e.target)) {
            langSelector.classList.remove('active');
        }
    });
</script>
<script src="\js\translationsForMiniApps.js"></script>



</html>