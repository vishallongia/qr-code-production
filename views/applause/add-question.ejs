<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Applause Event</title>
    <link rel="icon" type="image/png" sizes="192x192" href="/app-icon-192.png">
    <link rel="stylesheet" href="/css/add-quiz-question.css" />
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
</head>

<body>

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
    </div>
    <% if (error) { %>
        <div class="quiz-error-message">
            <%= error %>
        </div>
        <% } else { %>
            <div class="quiz-container">
                <nav class="breadcrumbs">
                    <a href="/tvstation/channels">Projects</a>
                    <span>&rsaquo;</span>
                    <a href="/tvstation/channels/<%= channel._id %>/sessions">Episodes</a>
                    <span>&rsaquo;</span>
                    <a href="/tvstation/channels/<%= channel._id %>/session/<%= sessionId %>">Events</a>
                    <span>&rsaquo;</span>
                    <a
                        href="/tvstation/applause/channels/<%= channel._id %>/session/<%= sessionId %>/applause">Applause</a>
                    <span>&rsaquo;</span>
                    <span class="active">Create a Applause Event</span>
                </nav>
                <h2>Create a New Applause Event</h2>
                <form id="questions-form">
                    <div id="questions-wrapper"></div>
                    <button type="submit" class="quiz-btn-submit">Save Applause Event</button>
                </form>
            </div>



            <template id="question-template">
                <div class="quiz-question-wrapper">
                    <div class="quiz-question-header">
                        <span class="quiz-question-title">Applause</span>
                        <div class="quiz-question-actions">
                            <button type="button" class="quiz-btn-collapse" style="display: none;">Collapse</button>
                            <button type="button" style="display: none;" class="quiz-btn-delete">Delete</button>
                        </div>
                    </div>
                    <div class="quiz-question-block">
                        <div class="quiz-form-group">
                            <label>Name of Your Channel </label>
                            <input type="text" name="logoTitle" placeholder="Enter logo title" />
                        </div>

                        <div class="quiz-form-group">
                            <label>Description of Your Channel Logo</label>
                            <input type="text" name="logoDescription" placeholder="Enter logo description" />
                        </div>

                        <div class="quiz-form-group">
                            <label>Logo Link </label>
                            <input type="url" name="logoLink" placeholder="https://example.com" />
                        </div>

                        <div class="quiz-form-group">
                            <label>Upload Your Channel Logo</label>
                            <label class="quiz-file-label">
                                <span class="quiz-file-label-text">Choose File</span>
                                <input type="file" class="quiz-logoImage quiz-hidden-file" accept="image/*" />
                            </label>
                            <img class="preview-img quiz-logoImagePreview" style="display: none;" />
                        </div>

                        <hr />
                        <div class="quiz-form-group">
                            <label>Name of Your Content</label>
                            <input type="text" name="question" placeholder="Name of Your Content" value="Who or What do you want to receive applause for?" required />
                        </div>

                        <div class="quiz-form-group">
                            <label>Description of Your Content</label>
                            <input type="text" name="questionDescription" placeholder="Description of Your Content" />
                        </div>

                        <div class="quiz-form-group">
                            <label>Upload Image (Preview) of Your Content</label>
                            <label class="quiz-file-label">
                                <span class="quiz-file-label-text">Choose File</span>
                                <input type="file" class="quiz-questionImage quiz-hidden-file" accept="image/*" />
                            </label>
                            <img class="preview-img quiz-questionImagePreview" style="display: none;" />
                        </div>

                        <div class="quiz-form-group">
                            <label>Link of Your Conent</label>
                            <input type="url" name="questionImageLink" placeholder="https://example.com" />
                        </div>

                        <div class="quiz-form-group" style="display: none;">
                            <label> Logo (optional)</label>
                            <label class="quiz-file-label">
                                <span class="quiz-file-label-text">Choose File</span>
                                <input type="file" class="quiz-questionLogo quiz-hidden-file" accept="image/*" />
                            </label>
                            <img class="preview-img quiz-questionLogoPreview" style="display: none;" />
                        </div>

                        <div class="quiz-option-wrapper">
                            <div class="quiz-option-blocks quiz-options-grid"></div>
                            <div class="quiz-option-controls">
                                <button type="button" class="quiz-btn-add-option">+ Add Option</button>
                            </div>
                        </div>
                        <input type="hidden" name="sessionId" value="<%= sessionId %>" />

                    </div>
                </div>
            </template>
            <% } %>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
<script src="/js/toastify-setup.js"></script>

<script>
    const wrapper = document.getElementById("questions-wrapper");
    const template = document.getElementById("question-template");

    function setupImagePreview(block) {
        const fileInputs = [
            { selector: ".quiz-questionImage", previewSelector: ".quiz-questionImagePreview" },
            { selector: ".quiz-questionLogo", previewSelector: ".quiz-questionLogoPreview" },
            { selector: ".quiz-logoImage", previewSelector: ".quiz-logoImagePreview" },
        ];

        fileInputs.forEach(({ selector, previewSelector }) => {
            const fileInput = block.querySelector(selector);
            const previewImg = block.querySelector(previewSelector);
            const labelText = fileInput?.previousElementSibling;
            const clearBtn = document.createElement("button");

            clearBtn.type = "button";
            clearBtn.innerText = "✕";
            clearBtn.className = "quiz-clear-btn";
            fileInput.parentElement.appendChild(clearBtn);

            fileInput?.addEventListener("change", function (e) {
                const file = e.target.files[0];
                if (file) {
                    previewImg.src = URL.createObjectURL(file);
                    previewImg.style.display = "block";
                    labelText.textContent = file.name;
                    clearBtn.style.display = "inline-block";
                }
            });

            clearBtn.addEventListener("click", () => {
                fileInput.value = "";
                previewImg.src = "";
                previewImg.style.display = "none";
                labelText.textContent = "Choose File";
                clearBtn.style.display = "none";
            });

            clearBtn.style.display = "none"; // Initially hidden
        });
    }

    function setupRewardModeSwitcher(block) {
        const modeButtons = block.querySelectorAll(".reward-mode-btn");
        const modeInput = block.querySelector('input[name="mode"]');
        const jackpotField = block.querySelector(".reward-jackpot");
        const digitalField = block.querySelector(".reward-digital");

        function clearFields(field) {
            field.querySelectorAll('input[type="text"], input[type="number"], input[type="url"], input[type="file"]').forEach(input => {
                input.value = '';
                if (input.type === 'file') {
                    input.value = '';
                    const labelText = input.parentElement.querySelector('.quiz-file-label-text');
                    if (labelText) labelText.textContent = 'Choose File';
                    const clearBtn = input.parentElement.querySelector('.quiz-clear-btn');
                    if (clearBtn) clearBtn.style.display = 'none';
                    const preview = block.querySelector(`.${input.classList[0]}Preview`);
                    if (preview) {
                        preview.src = '';
                        preview.style.display = 'none';
                    }
                }
            });
        }

        modeButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const mode = btn.dataset.mode;
                modeInput.value = mode;

                if (mode === "jackpot") {
                    jackpotField.style.display = "block";
                    digitalField.style.display = "none";
                    clearFields(digitalField);
                } else if (mode === "digital") {
                    jackpotField.style.display = "none";
                    digitalField.style.display = "block";
                    clearFields(jackpotField);
                } else if (mode === "both") {
                    jackpotField.style.display = "block";
                    digitalField.style.display = "block";
                } else if (mode === "none") {
                    jackpotField.style.display = "none";
                    digitalField.style.display = "none";
                    clearFields(jackpotField);
                    clearFields(digitalField);
                }

                modeButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
            });
        });
    }



    function generateOptionBlock(block, index) {
        const optDiv = document.createElement("div");
        optDiv.className = "quiz-option-block";

        const label = document.createElement("label");
        label.innerText = `Option ${index + 1}`;

        const inputText = document.createElement("input");
        inputText.type = "text";
        inputText.required = true;
        inputText.placeholder = "Name of the Image (of the post, video, story, specific guest, any special detail - like the sound, etc.)";

        // Option Description
        const inputDesc = document.createElement("input");
        inputDesc.type = "text";
        inputDesc.placeholder = "Enter the Description of the Image";
        inputDesc.className = "quiz-option-description";


        // Magic Coin Deducted per option
        const coinInput = document.createElement("input");
        coinInput.type = "number";
        coinInput.name = "magicCoinDeducted[]";
        coinInput.min = "0";
        coinInput.value = "";
        coinInput.required = true;
        coinInput.placeholder = "Select Your Desired Amount for Your Applause, or Your Fans their free Choice";

        const fileLabel = document.createElement("label");
        fileLabel.className = "quiz-file-label";
        const fileText = document.createElement("span");
        fileText.className = "quiz-file-label-text";
        fileText.innerText = "Choose Image";
        const inputFile = document.createElement("input");
        inputFile.type = "file";
        inputFile.accept = "image/*";
        inputFile.className = "quiz-option-image-input quiz-hidden-file";
        inputFile.dataset.index = index;
        fileLabel.append(fileText, inputFile);

        const clearBtn = document.createElement("button");
        clearBtn.type = "button";
        clearBtn.className = "quiz-clear-btn";
        clearBtn.innerText = "✕";
        clearBtn.style.display = "none";
        fileLabel.appendChild(clearBtn);

        const previewImg = document.createElement("img");
        previewImg.className = `preview-img quiz-optionPreview${index}`;
        previewImg.style.display = "none";

        inputFile.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
                previewImg.src = URL.createObjectURL(file);
                previewImg.style.display = "block";
                fileText.innerText = file.name;
                clearBtn.style.display = "inline-block";
            }
        });

        clearBtn.addEventListener("click", () => {
            inputFile.value = "";
            previewImg.src = "";
            previewImg.style.display = "none";
            fileText.innerText = "Choose Image";
            clearBtn.style.display = "none";
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "quiz-option-delete-btn";
        deleteBtn.innerText = "✕";
        deleteBtn.addEventListener("click", () => {
            const allOptions = block.querySelectorAll(".quiz-option-block");
            if (allOptions.length > 1) {
                optDiv.remove();
                renumberOptions(block);
            } else {
                alert("At least two options are required.");
            }
        });

        // optDiv.append(label, inputText, inputDesc, coinInput, fileLabel, previewImg, deleteBtn);
        optDiv.append(label, fileLabel, previewImg, deleteBtn, inputText, inputDesc, coinInput);
        return optDiv;
    }



    function renumberOptions(block) {
        const optionBlocks = block.querySelectorAll(".quiz-option-block");
        optionBlocks.forEach((optBlock, index) => {
            const label = optBlock.querySelector("label");
            if (label) label.innerText = `Option ${index + 1}`;

            const previewImg = optBlock.querySelector(".preview-img");
            if (previewImg) previewImg.className = `preview-img quiz-optionPreview${index}`;
        });
    }

    function generateOptions(block, count = 0) {
        const optionContainer = block.querySelector(".quiz-option-blocks");
        optionContainer.innerHTML = "";

        for (let i = 0; i < count; i++) {
            const optDiv = generateOptionBlock(block, i);
            optionContainer.appendChild(optDiv);
        }

    }

    function createQuestionBlock() {
        wrapper.innerHTML = ""; // only one question per form

        const clone = template.content.cloneNode(true);
        const block = clone.querySelector(".quiz-question-wrapper");

        const collapseBtn = block.querySelector(".quiz-btn-collapse");
        const deleteBtn = block.querySelector(".quiz-btn-delete");
        const questionBlock = block.querySelector(".quiz-question-block");

        collapseBtn.addEventListener("click", () => {
            questionBlock.style.display = questionBlock.style.display === "none" ? "block" : "none";
            collapseBtn.textContent = questionBlock.style.display === "none" ? "Expand" : "Collapse";
        });

        deleteBtn.addEventListener("click", () => {
            block.remove();
        });

        const addOptionBtn = block.querySelector(".quiz-btn-add-option");
        addOptionBtn.addEventListener("click", () => {
            const currentOptions = block.querySelectorAll(".quiz-option-block").length;
            const newOption = generateOptionBlock(block, currentOptions);
            block.querySelector(".quiz-option-blocks").appendChild(newOption);
        });

        generateOptions(block, 1); // start with 2 options
        setupImagePreview(block);
        setupRewardModeSwitcher(block); // ← Add this line
        wrapper.appendChild(block);
    }

    document.getElementById("questions-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const block = document.querySelector(".quiz-question-wrapper");
        const formData = new FormData();

        const channelId = "<%= channel?._id %>";
        const sessionId = "<%= sessionId %>";
        formData.append("sessionId", sessionId);
        formData.append("channelId", channelId);
        formData.append("question", block.querySelector('input[name="question"]').value.trim());
        formData.append("questionDescription", block.querySelector('input[name="questionDescription"]').value.trim());
        formData.append("logoTitle", block.querySelector('input[name="logoTitle"]').value.trim());
        formData.append("logoDescription", block.querySelector('input[name="logoDescription"]').value.trim());
        formData.append("logoLink", block.querySelector('input[name="logoLink"]').value.trim());


        const logoImage = block.querySelector(".quiz-logoImage")?.files[0];
        if (logoImage) formData.append("logo", logoImage);

        const questionImage = block.querySelector(".quiz-questionImage")?.files[0];
        const questionLogo = block.querySelector(".quiz-questionLogo")?.files[0];
        const questionImageLink = block.querySelector('input[name="questionImageLink"]').value.trim();

        if (questionImage) formData.append("questionImage", questionImage);
        if (questionLogo) formData.append("questionLogo", questionLogo);
        if (questionImageLink) formData.append("questionImageLink", questionImageLink);

        const options = block.querySelectorAll(".quiz-option-block");
        const optionData = [];

        options.forEach((opt, index) => {
            const text = opt.querySelector('input[type="text"]').value.trim();
            const description = opt.querySelector('.quiz-option-description')?.value.trim() || "";
            const magicCoinDeducted = parseInt(opt.querySelector('input[type="number"]').value) || 0;
            const file = opt.querySelector('input[type="file"]')?.files[0];
            const imageName = file ? file.name : null;

            optionData.push({ text, description, imageName, magicCoinDeducted });


            if (file) {
                formData.append("optionsImages", file); // all images under same key
            }
        });

        formData.append("options", JSON.stringify(optionData));
        const loader = document.getElementById("loader");
        loader.style.display = "flex"; // show loader

        // Convert FormData to a plain object
        const formDataObj = {};
        formData.forEach((value, key) => {
            // If key already exists, make it an array (for duplicate keys like optionsImages)
            if (formDataObj[key]) {
                if (!Array.isArray(formDataObj[key])) {
                    formDataObj[key] = [formDataObj[key]];
                }
                formDataObj[key].push(value);
            } else {
                formDataObj[key] = value;
            }
        });

        try {
            const res = await fetch("/tvstation/applause/applause-question/create", {
                method: "POST",
                body: formData,
            });

            const result = await res.json();
            if (result.type === "success") {
                showToast(result.message || "Question saved successfully!", "success");

                const { channelId, sessionId, _id } = result.data; // ✅ Extract
                setTimeout(() => {
                    window.location.href = `/tvstation/applause/channels/${channelId}/session/${sessionId}/editquestion/${_id}`;
                }, 1000);
            } else {
                showToast(result.message || "Something went wrong.", "error");
            }
        } catch (err) {
            console.error("Error submitting question:", err);
            showToast("Failed to submit question. Please try again.", "error");
        }
        finally {
            loader.style.display = "none"; // hide loader after fetch is done
        }
    });

    createQuestionBlock();
</script>


</html>