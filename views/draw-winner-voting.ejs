<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Draw Winner</title>
    <link rel="stylesheet" href="/css/draw-winner.css" />
    <link rel="icon" type="image/png" sizes="192x192" href="/app-icon-192.png">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
</head>

<body>

    <!-- Winner Popup -->
    <!-- Pre-confirmation Winner Popup -->
    <div id="preWinnerPopup" class="winner-popup hidden">
        <div class="popup-card">
            <h2>Select Winner</h2>
            <p id="prePopupName"></p>
            <p id="prePopupEmail"></p>
            <p id="prePopupCoins"></p>
            <div class="popup-buttons">
                <button id="preConfirmBtn">Confirm</button>
                <button id="preRetryBtn">Retry</button>
                <button id="preCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Breadcrumbs -->
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
    </div>

    <% if (error) { %>
        <div class="quiz-admin-error">
            <%= error %>
        </div>
        <% } else { %>
            <nav class="breadcrumbs">
                <a href="/tvstation/channels">Projects</a>
                <span>&rsaquo;</span>
                <a href="/tvstation/channels/<%= channel._id %>/sessions">Episodes</a>
                <span>&rsaquo;</span>
                <a href="/tvstation/channels/<%= channel._id %>/session/<%= sessionId %>">Events</a>
                <span>&rsaquo;</span>
                <a href="/tvstation/channels/<%= channel._id %>/session/<%= sessionId %>/voting">Voting</a>
                <span>&rsaquo;</span>
                <span class="active">Voting Quiz Draw</span>
            </nav>
            <!-- Winner Animation Container -->
            <!-- Jackpot Winner Animation -->
            <div id="jackpotWinnerAnimation" class="winner-animation hidden">
                <div class="winner-card">
                    <button class="close-btn" onclick="closeAnimation('jackpot')">&times;</button>
                    <h2>üé∞ Jackpot Winner!</h2>
                    <p id="jackpotWinnerName"></p>
                    <p id="jackpotWinnerCoins"></p>
                </div>
            </div>

            <!-- Digital Winner Animation -->
            <div id="digitalWinnerAnimation" class="winner-animation hidden">
                <div class="winner-card">
                    <button class="close-btn" onclick="closeAnimation('digital')">&times;</button>
                    <h2>üéÅ Digital Reward Winner!</h2>
                    <p id="digitalWinnerName"></p>
                    <p id="digitalWinnerCoins"></p>
                </div>
            </div>
            <div class="modern-list-container">
                <h1 style="text-align:center;">üéâ Draw Voting Winner</h1>

                <div class="draw-wrapper">
                    <!-- Jackpot Participants -->
                    <div class="participants-container" id="jackpotContainer">
                        <h2>Jackpot Participants</h2>
                        <div class="list-wrapper">
                            <% if (jackpotParticipants && jackpotParticipants.length> 0) { %>
                                <div class="list-header jackpot-header">
                                    <span>#</span>
                                    <span>User</span>
                                    <span>Email</span>
                                    <span>Coins Used</span>
                                </div>
                                <ul class="user-list" id="jackpotList">
                                    <% jackpotParticipants.forEach((p, index)=> { %>
                                        <li class="user-item jackpot-item" data-id="<%= p.userId %>"
                                            data-response-id="<%= p._id %>">
                                            <span>
                                                <%= index + 1 %>
                                            </span>
                                            <span>
                                                <%= p.user %>
                                            </span>
                                            <span>
                                                <%= p.email %>
                                            </span>
                                            <span>
                                                <%= p.coins %>
                                            </span>
                                        </li>
                                        <% }) %>
                                </ul>
                                <% } else { %>
                                    <p style="text-align:center; color:#888; padding: 20px; font-style: italic;">
                                        No contestants participated yet.
                                    </p>
                                    <% } %>
                        </div>
                        <div class="draw-buttons">
                            <% if (jackpotParticipants && jackpotParticipants.length> 0) { %>
                                <button class="draw-btn" id="drawJackpot">üé∞ Draw Jackpot Winner</button>
                                <% } %>
                        </div>
                    </div>


                    <!-- Separator only if both sections exist -->
                    <% if ((jackpotParticipants && jackpotParticipants.length> 0) && (digitalRewardParticipants
                        && digitalRewardParticipants.length > 0)) { %>
                        <div class="separator-vertical"></div>
                        <% } %>

                            <!-- Digital Reward Participants -->
                            <div class="participants-container" id="digitalContainer">
                                <h2>Digital Reward Participants</h2>
                                <div class="list-wrapper">
                                    <% if (digitalRewardParticipants && digitalRewardParticipants.length> 0) {
                                        %>
                                        <div class="list-header digital-header">
                                            <span>#</span>
                                            <span>User</span>
                                            <span>Email</span>
                                            <span>Coins Used</span>
                                        </div>
                                        <ul class="user-list" id="digitalList">
                                            <% digitalRewardParticipants.forEach((p, index)=> { %>
                                                <li class="user-item digital-item" data-id="<%= p.userId %>"
                                                    data-response-id="<%= p._id %>">
                                                    <span>
                                                        <%= index + 1 %>
                                                    </span>
                                                    <span>
                                                        <%= p.user %>
                                                    </span>
                                                    <span>
                                                        <%= p.email %>
                                                    </span>
                                                    <span>
                                                        <%= p.coins %>
                                                    </span>
                                                </li>
                                                <% }) %>
                                        </ul>
                                        <% } else { %>
                                            <p
                                                style="text-align:center; color:#888; padding: 20px; font-style: italic;">
                                                No contestants participated yet.
                                            </p>
                                            <% } %>
                                </div>
                                <div class="draw-buttons">
                                    <% if (digitalRewardParticipants && digitalRewardParticipants.length> 0) { %>
                                        <button class="draw-btn" id="drawDigital">üéÅ Draw Digital Reward Winner</button>
                                        <% } %>
                                </div>

                            </div>

                </div>
            </div>
            <% } %>

                <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
                <script src="/js/toastify-setup.js"></script>

                <script>
                    const jackpotBtn = document.getElementById("drawJackpot");
                    const digitalBtn = document.getElementById("drawDigital");
                    const loader = document.getElementById("loader");

                    // --- Pre-confirmation popup ---
                    const prePopup = document.getElementById("preWinnerPopup");
                    const preName = document.getElementById("prePopupName");
                    const preEmail = document.getElementById("prePopupEmail");
                    const preCoins = document.getElementById("prePopupCoins");
                    const preConfirmBtn = document.getElementById("preConfirmBtn");
                    const preRetryBtn = document.getElementById("preRetryBtn");
                    const preCloseBtn = document.getElementById("preCloseBtn");

                    let currentMode = null;
                    let selectedParticipant = null;

                    function getParticipants(mode) {
                        const listId = mode === "jackpot" ? "jackpotList" : "digitalList";
                        const items = document.querySelectorAll(`#${listId} .user-item`);
                        return Array.from(items).map(li => ({
                            userId: li.dataset.id,
                            user: li.children[1].textContent,
                            email: li.children[2].textContent,
                            responseId: li.dataset.responseId, // üëà Add this
                            coins: li.children[3].textContent
                        }));
                    }

                    function pickRandomParticipant(mode) {
                        const participants = getParticipants(mode);
                        if (!participants.length) return null;
                        return participants[Math.floor(Math.random() * participants.length)];
                    }

                    function showPrePopup(mode) {
                        currentMode = mode;
                        selectedParticipant = pickRandomParticipant(mode);
                        if (!selectedParticipant) return showToast("No participants!", "error");

                        preName.textContent = `Name: ${selectedParticipant.user}`;
                        preEmail.textContent = `Email: ${selectedParticipant.email}`;
                        preCoins.textContent = `Coins Used: ${selectedParticipant.coins}`;
                        prePopup.classList.remove("hidden");
                    }

                    preConfirmBtn.addEventListener("click", () => {
                        prePopup.classList.add("hidden");
                        drawWinner(currentMode, selectedParticipant.userId, selectedParticipant.responseId);
                    });


                    preRetryBtn.addEventListener("click", () => {
                        selectedParticipant = pickRandomParticipant(currentMode);
                        if (!selectedParticipant) return showToast("No participants!", "error");
                        preName.textContent = `Name: ${selectedParticipant.user}`;
                        preEmail.textContent = `Email: ${selectedParticipant.email}`;
                        preCoins.textContent = `Coins Used: ${selectedParticipant.coins}`;
                    });

                    preCloseBtn.addEventListener("click", () => prePopup.classList.add("hidden"));


                    // --- Main drawWinner function ---
                    async function drawWinner(mode, userId = null,responseId = null) { // optional userId for pre-selected winner
                        if (!mode) return;
                        loader.style.display = "flex"; // show loader

                        try {
                            const bodyData = { type: "voting", mode };
                            if (userId) bodyData.userId = userId; 
                            if (responseId) bodyData.responseId = responseId; 

                            const res = await fetch(
                                `/tvstation/channels/<%= channel._id %>/session/<%= sessionId %>/voting/draw`,
                                {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify(bodyData),
                                }
                            );

                            const result = await res.json();

                            if (result.type === "success") {
                                const winner = result.data.winner;

                                // Hide the draw button permanently
                                if (mode === "jackpot") jackpotBtn.style.visibility = "hidden";
                                else digitalBtn.style.visibility = "hidden";

                                // Update participant list
                                if (mode === "jackpot") {
                                    const list = document.getElementById("jackpotList");
                                    if (list) {
                                        list.innerHTML = `<li class="user-item jackpot-item winner-badge" data-id="${winner.userId}">
            <span class="winner-badge">Winner</span>                               
            <span>${winner.user}</span>
            <span>${winner.email}</span>
            <span>${winner.coins}</span>
        </li>`;
                                    }
                                } else if (mode === "digital") {
                                    const list = document.getElementById("digitalList");
                                    if (list) {
                                        list.innerHTML = `<li class="user-item digital-item winner-badge" data-id="${winner.userId}">
            <span class="winner-badge">Winner</span>
            <span>${winner.user}</span>
            <span>${winner.email}</span> 
            <span>${winner.coins}</span> 
        </li>`;
                                    }
                                }

                                // Show winner animation
                                const animId = mode === "jackpot" ? "jackpotWinnerAnimation" : "digitalWinnerAnimation";
                                const nameId = mode === "jackpot" ? "jackpotWinnerName" : "digitalWinnerName";
                                const coinsId = mode === "jackpot" ? "jackpotWinnerCoins" : "digitalWinnerCoins";

                                document.getElementById(animId).style.display = "flex";
                                document.getElementById(nameId).textContent = winner.user;
                                document.getElementById(coinsId).textContent = `Coins Used: ${winner.coins}`;
                                const msgPara = document.createElement("p");
                                msgPara.className = "winner-message";
                                msgPara.textContent = result.message;
                                document.getElementById(animId).querySelector(".winner-card").appendChild(msgPara);
                            } else {
                                showToast(result.message || "Something went wrong.", "error");
                            }
                        } catch (err) {
                            console.error("Error drawing winner:", err);
                            showToast("Failed to draw winner. Please try again.", "error");
                        } finally {
                            loader.style.display = "none"; // hide loader
                        }
                    }

                    // Close winner animation
                    function closeAnimation(mode) {
                        const animId = mode === "jackpot" ? "jackpotWinnerAnimation" : "digitalWinnerAnimation";
                        document.getElementById(animId).style.display = "none";
                    }

                    // Attach main buttons to pre-popup flow
                    if (jackpotBtn) jackpotBtn.addEventListener("click", () => showPrePopup("jackpot"));
                    if (digitalBtn) digitalBtn.addEventListener("click", () => showPrePopup("digital"));

                </script>



</body>

</html>